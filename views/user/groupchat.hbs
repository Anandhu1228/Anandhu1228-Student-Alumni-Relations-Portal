<!-- 
Website developed by Anandhu Mohan for the Alumni Relations Cell of a college. 
Features include:
  - Job portal, Internship portal, Mentorship portal
  - Search functionality for users, students, and alumni
  - Group chat and private individual chat systems
  - Notification system and user profiles for each member
  - Admin panel to control the entire site, handle issues, and manage inquiries
  - Superadmin overseeing the activities of admins and users
  - Maintainer responsible for the main page content and styling, visible to users and external visitors
  - Advanced machine learning features that sort jobs and internships based on user profile preferences
  - Periodic email notifications and security enhancements
-->

<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>

    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        /*overflow: hidden; /* Keep the body from scrolling */
    }

    #chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh; /* Ensure chat-container takes full viewport height */
        padding: 20px;
        padding-top: 180px;
        padding-bottom: 0px;
        border: none;
        overflow: hidden; /* Prevent scrolling on chat-container itself */
    }

    #chat-messages {
        flex-grow: 1; /* Let this section take up the available space */
        overflow-y: auto; /* Allow scrolling inside this section */
        height: auto;
        position: relative;
    }

    #chat-form {
        display: flex;
        align-items: center;
        flex-shrink: 0; /* Prevent it from shrinking */
        padding: 10px 0; /* Add padding for some space */
        padding-top: 4px;
    }

    body {
        background-image: url('/images/logo2.png');
        background-size: 70% auto;
        background-position: center bottom 55%;
        background-repeat: no-repeat;
    }

    @media (max-width: 1350px) {
        #chat-container {
            padding-top: 170px;
        }
    }

    @media (max-width: 1250px) {
        #chat-container {
            padding-top: 160px;
        }
    }

    @media (max-width: 550px) {
        #chat-container {
            padding-top: 150px;
        }
    }

    @media (max-width: 768px) {
        body {
            background-image: url('/images/logo1.png');
            background-position: center bottom 40%;
        }
    }

    .message {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding: 10px;
        position: relative;
        border: none;
        width: 80%;
        box-shadow: 0 0px 4px rgba(0, 0, 0, 0.4);
        transition: background-color 0.5s ease, box-shadow 0.3s ease;
        background-color: #e8e6e6;
        max-width: 900px;
        margin-right: 10px;
        border-radius: 0px 20px 20px 20px;
    }

    .option_div {
        position: absolute;
        top: 0px;
        right: 10px;
        cursor: pointer;
    }

    .dropdownND {
        display: none;
        position: absolute;
        top: 30px;
        right: 0;
        background-color: rgb(255, 255, 255);
        box-shadow: 0 0px 4px rgba(0, 0, 0, 0.4);
        border-radius: 5px;
        z-index: 997;
    }

    .dropdownND ul {
        list-style-type: none;
        padding: 3px;
        margin: 0;
    }

    .dropdownND ul li {
        padding-left: 5px;
        padding-right: 5px;
        font-weight: 600;
        cursor: pointer;
    }

    @media (max-width: 500px) {
        .dropdownND ul li {
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
    }

    .dropdownND ul li:hover {
        background-color: #ffffff;
        border-radius: 8px;
    }

    .emoji-popup {
        display: none;
        position: absolute;
        top: 30px;
        right: 0;
        z-index: 997;
        background-color: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0px 4px rgba(0, 0, 0, 0.4);
        border-radius: 5px;
        padding: 10px;
    }

    .emoji-popup span {
        font-size: 24px;
        margin: 5px;
        cursor: pointer;
        display: inline-block;
    }

    @media (max-width: 900px) {
        .emoji-popup span {
            font-size: 18px;
        }
    }

    @media (max-width: 620px) {
        .emoji-popup span {
            font-size: 16px;
        }
    }

    .emoji-popup span:hover {
        background-color: #ffffff;
        border-radius: 50%;
    }

    .message:hover{
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }

    .user-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 10px;
        position: absolute;
        top: 10px;
    }

    .user-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .user-name {
        position: absolute;
        top: 10px;
        left: 70px;
        font-weight: 600;
        color: rgb(78, 74, 74);
    }

    #send-icon {
        font-size: 24px;
        cursor: pointer;
        margin-left: 10px;
        color: #2196f3;
    }

    #send-button {
        font-size: 16px;
        cursor: pointer;
        margin-left: 10px;
        background-color: #2196f3;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
    }

    .reply_link {
        padding: 0px;
        color: #0868b7;
        cursor: pointer;
        border: none;
        background: none;
        font-weight: 600;
        font-size: 12px;
        margin: 0px;
    }

    .reply_del_div{
        position: absolute;
        left: 0px;
        bottom: 5px;
        display: flex;
        margin-bottom:0px;
        margin-left: 20px;
    }

    .reply {
        background-color: #e0f7fa;
        color: black;
        padding: 5px;
        margin-left: 90px;
        margin-bottom: 0px;
        margin-top: 25px;
        font-size: 0.9em;
        border-radius: 5px;
        flex-grow: 1;
        max-height: 50px;
        overflow: auto; 
        word-wrap: break-word;
        cursor: pointer;
    }

    .replytext{
        overflow: auto; 
        word-wrap: break-word;
        display: inline;
        font-size: 13px;
    }

    .repliedTO{
        display: inline;
        font-weight: 600;
    }

    .actual-message {
        margin-top: 30px;
        margin-bottom: 10px;
        margin-left: 70px;
        max-width: 80%;
        word-wrap: break-word;
        font-weight: 600;
    }

    .message_content_class {
        overflow: hidden;
        max-height: calc(1.5em * 6); /* Limit to 6 lines */
        transition: max-height 0.3s ease; /* Smooth transition for expanding/collapsing */
        width: 109%;
    }

    .message_content_class.expanded {
        max-height: none; /* Allow full expansion */
    }

    .show_more {
        color: #5e6063;
        cursor: pointer;
        margin-top: 5px;
        display: none;
    }

    .show_more.active {
        display: inline;
    }

    #message-input {
        width: 80%;
        min-height: 60px;
        height: auto;
        resize: vertical;
        border: 2px solid #ffffff;
        border-radius: 10px;
        padding: 10px;
        background-color: #ddd;
        box-shadow: 2px 2px 4px #dcdcdc;
        font-size: 16px;
        max-height: 500px;
        margin-bottom: 0px;
    }

    .popup-form {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 5px;
        z-index: 2001;
        min-width: 40%;
        width: auto;
        height: auto;
    }

    #uploadForm {
        background-color: rgb(178, 206, 234);
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        padding: 50px;
        padding-top: 30px;
        background-image: url('/images/logo_transparent1.png');
        background-size: 135% auto;
        background-position: center bottom 45%;
        background-repeat: no-repeat;
        z-index: 101;
    }

    .popupform_seemore {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 5px;
        z-index: 2001;
        min-width: 40%;
        width: auto;
        max-height: 90vh; /* Ensures the popup does not exceed 90% of the viewport height */
        overflow: hidden; /* Hides overflow content */
        border-radius: 20px;
        box-shadow: 0 4px 30px 15px rgba(0, 0, 0, 0.2);
    }

    #seemore_popup_form {
        background-color: rgb(255, 255, 255);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        padding: 50px;
        padding-top: 20px;
        background-image: url('/images/logo_transparent1.png');
        background-size: 135% auto;
        background-position: center bottom 45%;
        background-repeat: no-repeat;
        z-index: 2001;
        overflow-y: auto; /* Adds vertical scroll */
        max-height: 90vh; /* Constrains the popup's height to 80% of the viewport height */
    }

    video.preview {
        pointer-events: none;
    }

    .formpostgroup {
        display: flex;
        flex-direction: column;
        margin-top: 0px;
    }

    .labelpostgroup {
        margin-top: 10px;
        font-weight: bold;
    }

    .textareapostgroup,
    .inputpostgroup {
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ffffff;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    .custom_text_area_postgroup{
        margin-bottom: 15px;
        margin-top:15px;
        max-height: 250px;
        min-height: 60px;
    }

    .inputpostgroup{
        border-radius: 20px;
        width: 100%;
        padding: 15px;
        font-weight: bold;
        border: none;
        box-shadow: 0 0px 4px rgba(0, 0, 0, 0.4);
        transition: box-shadow 0.3s ease;
    }

    .buttonpostgroup {
        color: #fff;
        padding: 10px;
        border: none;
        color: black;
        font-weight: bold;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 0px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .buttonpostgroup:hover {
        background-color: #d5dade;
    }

    .custom-file-upload {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
        display: inline-block;
        padding: 10px;
        cursor: pointer;
        background-color: white;
        margin-top: 0px;
        border-radius: 15px;
    }

    .custom-file-upload i {
        margin-right: 5px;
    }

    #imageCarousel {
        text-align: center;
        margin: auto;
    }

    .grid-container {
        margin-top: 20px;
        margin-left: 30px;
        margin-right: 1px;
        margin-bottom: 1px;
        display: grid;
        background-color: none;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        max-width: 400px;
        max-height: 400px;
        overflow: hidden;
        padding: 8px;
        border-radius: 10px;
        position: relative;
    }

    .grid-item {
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .preview {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }

    .see-more-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        opacity: 0.7; /* Updated opacity value */
        transition: opacity 0.3s ease-in-out;
    }

    .see-more-button {
        background: none;
        border: none;
        color: blue;
        cursor: pointer;
        color: black;
        font-weight: 600;
    }

    .grid-item:hover .see-more-overlay {
        opacity: 1;
    }

    .hidden {
        display: none;
    }

    .extra-items .grid-item:nth-child(n+4) {
      display: none;
    }

    .extra-items .grid-item.see-more-item {
      display: block;
    }

    .close_pop_up{
        font-size: 20px;
    }

    .close_pop_up:hover{
        color: red;
    }

    .delete_time{
        font-size: 10px; 
        position:absolute;
        right: 15px;
        bottom:-5px;
        font-weight: bold;
        margin-bottom: 5px;
        color:red;
    }

    .post_time{
        color:rgb(78, 74, 74);
        font-size: 10px; 
        position:absolute;
        right: 15px;
        bottom:5px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .no_delete_time{
        color:rgb(78, 74, 74);
        font-size: 10px; 
        position:absolute;
        right: 15px;
        bottom:0px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .button_plus{
        margin-left: 10px;
    }

    .carousel-inner{
        max-height: 250px;
        width: 100%;
    }

    .video-preview_popup{
        width: 100%;
        height: 88%;
    }

    .image-preview_popup{
        width: 100%;
        max-height: 250px;
    }

    @media (max-width: 750px) {
        .actual-message {
            margin-right: 50px;
        }
    }

    @media (max-width: 650px) {
        .actual-message {
            margin-right: 40px;
            font-size: 15px;
        }
    }

    @media (max-width: 550px) {
        .actual-message {
            margin-right: 30px;
        }
    }

    @media (max-width: 460px) {
        .actual-message {
            margin-right: 20px;
            font-size: 14px;
            margin-left: 45px;
        }
    }

    @media (max-width: 400px) {
        .actual-message {
            margin-right: 15px;
        }
    }

    @media (max-width: 1550px) {
        .popup-form {
            min-width: 50%;
        }
        .popupform_seemore{
            min-width: 50%;
        }
    }

    @media (max-width: 1250px) {
        .popup-form {
            min-width: 54%;
        }
        .popupform_seemore {
            min-width: 54%;
        }
    }

    @media (max-width: 1050px) {
        .popup-form {
            min-width: 58%;
        }
        .popupform_seemore {
            min-width: 58%;
        }
    }

    @media (max-width: 850px) {
        .popup-form {
            min-width: 62%;
        }
        .popupform_seemore {
            min-width: 62%;
        }
    }

    @media (max-width: 650px) {
        .popup-form {
            min-width: 90%;
        }
        #uploadForm {
            padding: 30px;
        }
        .popupform_seemore {
            min-width: 90%;
        }
        #seemore_popup_form {
            padding: 30px;
            padding-top: 10px;
        }
        .reply{
            margin-left: 70px;
        }
    }

    @media (max-width: 560px) {
        .button_plus{
            width: 40px;
        }
        #send-button{
            width: 60px;
            font-size: 14px;
        }
        .no_delete_time,.post_time,.delete_time{
            font-size: 9px;
        }
    }

    @media (max-width: 480px) {
        .button_plus{
            width: 30px;
            padding: 2px;
            margin-left: 4px;
            font-size: 18px;
            height: 30px;
        }
        .see-more-button {
            font-size: 14px;
        }
        #send-button{
            width: 50px;
            font-size: 13px;
            padding: 5px;
            font-weight: 500;
            margin-left: 4px;
        }
    }

    @media (max-width: 391px) {
        .inputpostgroup{
            font-size: 14px;
        }
        .see-more-button {
            font-size: 12px;
        }
    }
    
    @media (max-width: 363px) {
        .inputpostgroup{
            font-size: 12px;
        }
    }

    @media (max-height: 960px) {
       .custom_text_area_postgroup{
            font-size: 15px;
            max-height: 310px;
        }
    }

    @media (max-height: 931px) {
       .custom_text_area_postgroup{
            max-height: 240px;
            font-size: 14.5px;
        }
    } 

    @media (max-height: 828px) {
       .custom_text_area_postgroup{
            max-height: 220px;
            font-size: 14px;
        }
    }

    @media (max-height: 800px) {
       .custom_text_area_postgroup{
            max-height: 170px;
            font-size: 14px;
        }
    }

    @media (max-height: 942px) and (max-width: 942px) {
       .carousel-inner{
            max-height: 200px;
            width: 100%;
        }
        .video-preview_popup{
            width: 100%;
            max-height: 200px;
        }
        .image-preview_popup{
            width: 100%;
            max-height: 200px;
        }
    }

    @media (max-height: 744px) and (max-width: 744px) {
        .carousel-inner{
            max-height: 170px;
            width: 100%;
        }
        .video-preview_popup{
            width: 100%;
            max-height: 170px;
        }
        .image-preview_popup{
            width: 100%;
            max-height: 170px;
        }
    }

    @media (max-height: 480px) and (max-width: 480px) {
       .carousel-inner{
            max-height: 140px;
            width: 100%;
        }
        .video-preview_popup{
            width: 100%;
            max-height: 140px;
        }
        .image-preview_popup{
            width: 100%;
            max-height: 140px;
        }
    }

    @media (max-height: 458px) and  (max-width: 458px) {
       .carousel-inner{
            max-height: 130px;
            width: 100%;
        }
        .video-preview_popup{
            width: 100%;
            max-height: 100%;
        }
        .image-preview_popup{
            width: 100%;
            max-height: 100%;
        }
    }

     /*@media (max-height: 990px) {
    *, ::after, ::before {
        box-sizing: content-box; 
    }
    }*/

    @media (max-height: 500px) {
        .message{
            margin-right: 2px;
        }
    }

     @media (max-width: 500px) {
        .replytext{
            font-size: 12px;
            font-weight: 600;
        }
    }

    .new_notification_group{
        background-color: rgb(93, 138, 222);
        padding:5px; 
        margin-bottom:30px;
        border-radius:7px; 
        display: flex; 
        justify-content: center; 
        align-items: center;
    }

    .p_new_notification{
        font-weight:bold;
        margin-bottom:0px;
        color:white;
    }

    .highlight {
        background-color: rgb(255, 230, 0) !important; /* Change this color as needed */
        transition: background-color 0.5s ease;
    }

    .reaction_div{
        position:absolute;
        right: 30px;
        cursor: pointer;
        bottom: -10px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        z-index: 2;
    }

    .reaction_thumb{
        margin-bottom: 0px;
        font-size: 18px;
        margin-right: 10px;
    }

    .count_reaction{
        font-weight: bold;
        font-size: 15px;
        margin-right: 1px;
        margin-left: 10px;
    }

    .popupform_view_reactions{
        display: none;
        padding: 20px;
        position: fixed;
        top: 50%;
        left: 50%;
        background-color: #ffffff;
        transform: translate(-50%, -50%);
        border-radius: 5px;
        z-index: 2001;
        min-width: 30%;
        max-width: 90%;
        max-height: 65vh;
        min-height: 20vh;
        height: auto;
        overflow-y: auto;
        border-radius: 20px;
        box-shadow: 0 4px 30px 15px rgba(0, 0, 0, 0.2);
    }

    .popupform_initialize_poll{
        display: none;
        padding: 20px;
        position: fixed;
        top: 50%;
        left: 50%;
        background-color: #ffffff;
        transform: translate(-50%, -50%);
        border-radius: 5px;
        z-index: 2001;
        min-width: 30%;
        max-width: 90%;
        min-height: 20vh;
        height: auto;
        overflow-y: auto;
        border-radius: 20px;
        box-shadow: 0 4px 30px 15px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 1270px) {
        .popupform_view_reactions,
        .popupform_initialize_poll{
            min-width: 60%;
            max-width: 90%;
        }
    }

    @media (max-width: 950px) {
        .popupform_view_reactions,
        .popupform_initialize_poll{
            min-width: 80%;
            max-width: 90%;
        }
    }

    .close_pop_up_view_reactions{
        font-size: 15px;
        z-index: 105;
        position: absolute; 
        top:5px; 
        right:10px;
        cursor: pointer;
    }

    .close_pop_up_view_reactions:hover{
        color: red;
    }

    .close_button{
        text-align: right;
        display:block;
        margin-bottom: 30px;
    }

    .no-scroll {
        overflow: hidden;
    }

    .user_circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 10px;
    }

    .user_image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .p_emoji{
        margin-bottom: 0px;
        display: flex;
        margin-left:auto;
        margin-right:60px;
    }

    .p_in_like_body_turnedon{
        font-weight:bold;
        margin-bottom:0px;
        color:black;
        cursor:pointer;
    }

    .reaction_divider{
        display: flex;
        align-items:center; 
        margin-bottom: 20px;
    }

    @media (max-width: 1420px) {
        .p_emoji{
            margin-right: 10px;
        }
    }

    @media (max-width: 850px) {
        .p_in_like_body_turnedon{
            font-size: 14px;
        }
    }

    @media (max-width: 450px) {
        .p_emoji{
            margin-right:9px;
        }
        .p_in_like_body_turnedon{
            font-size: 12px;
        }
        .popupform_view_reactions,
        .popupform_initialize_poll{
            padding: 15px;
        }
    }

    .bot_p_1{
        margin-top:40px;
        font-weight: 600;
        font-size:14px;
        margin-bottom:5px;
        color:grey;
        text-align: center;
    }

    .bot_p_2{
        font-weight: 600;
        font-size:14px;
        margin-bottom:0px;
        color:grey;
        text-align: center;
    }

    @media (max-width: 950px) {
        .bot_p_1{
            font-size: 10px;
        }
        .bot_p_2{
            font-size: 10px;
        }
    }

    @media (max-width: 650px) {
        .user-name {
            top: 10px;
            left: 50px;
        }
        #message-input {
            height: 25px;
            font-size: 14px;
        }
        .actual-message{
            margin-left: 40px;
        }
    }

    @media (max-width: 500px){
        .repliedTO{
            font-size: 12px;
        }
    }

    @media (max-width: 450px) {
        .user-name {
            font-size: 12px;
        }
        .reply{
            margin-left: 40px;
        }
        .actual-message{
            margin-left: 22px;
            margin-right: 0px;
            font-size: 13px;
        }
        .replytext{
            font-size: 10px;
        }
        #message-input {
            height: 15px;
            font-size: 13px;
        }
    }

    video.preview {
        pointer-events: none;
    }

    #loading-indicator, 
    #loading-indicator_loader {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        z-index: 1000;
    }

    #loading-indicator p,
    #loading-indicator_loader p {
        margin: 10px 0;
        font-size: 18px;
        font-weight: bold;
    }

    #loading-indicator .spinner,
    #loading-indicator_loader .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    } 

    .option_div_main{
        position: sticky;
        top:0px;right:15px;
        cursor:pointer;
        background-color: rgb(93, 138, 222);
        z-index:998;
        font-size: 15px;
        border-radius: 5px;
        display: flex; 
        justify-content: center; 
        align-items: center;
        display: none;
        border: 1px solid rgb(93, 138, 222);
    }

    .option_div_main2{
        position: sticky;
        top:26px;right:15px;
        cursor:pointer;
        background-color: rgb(93, 138, 222);
        z-index:998;
        border-radius: 5px;
        display: flex; 
        font-size: 15px;
        justify-content: center; 
        align-items: center;
        border: 1px solid rgb(93, 138, 222);
    } 

    @media (max-width: 500px){
        .option_div_main,.option_div_main2{
            font-size: 14px;
        }
    }

    .poll_heading{
        overflow: auto; 
        word-wrap: break-word;
        font-size: 18px;
        font-weight: bold;
    }

    .view_vote{
        width: 100%;
        font-weight: bold;
        padding: 3px;
    }

    @media (max-width: 720px){
        .poll_heading{
            font-size: 16px;
        }
    }

    @media (max-width: 500px){
        .poll_heading{
            font-size: 15px;
        }
    }

    @media (max-width: 400px){
        .poll_heading{
            font-size: 14px;
        }
    }

    .plus_button_option{
        background-color: rgb(93, 138, 222);
        color: white;
        padding: 6px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 10px;
        margin-bottom: 5px;
    }

    @media (max-width: 469px){
        .plus_button_option{
            width: 100%;
        }
    }

    .init_poll_text{
        width: 100%;
        border-radius:10px;
        padding: 6px;
        min-height: 30px;
        border: 2px solid rgb(189, 186, 186);
    }

    .add_opt_btn{
        background-color: rgb(155, 154, 154);
        color: white;
        padding: 6px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 10px;
        margin-bottom: 5px;
    }

    .option_poll{
        border-radius: 5px;
        margin-bottom: 5px;
        width: 87%;
        border: 2px solid gray;
    }

    .submit_poll_my{
        width: 100%;
        font-weight: 600; 
        border: 1px solid rgb(255, 255, 255);
        padding: 3px;
        background-color: rgb(93, 138, 222); 
        color:white;
        padding:2px;
        border-radius:20px;
    }

    .user-circle_for_poll {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 10px;
    }

    .profileImageAlternate {
        -webkit-user-drag: none;  /* Safari */
        user-drag: none;           /* Non-prefixed version */
    }

    .reaction_hidden_time {
        font-size: 10px;
        font-weight: bold;
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        width: 100%;
        margin-bottom: 0px;
        color: #696b6d;
    }

    @media (max-width: 450px){
        .reaction_thumb{
            font-size: 15px;
        }

        .count_reaction{
            font-size: 12px;
        }
    }

    .top_bar{
        font-weight: bold;
        color:white;
        margin-bottom:0px;
    }

    .top_bar_close{
        position: absolute; 
        top:0px; right:10px;
        cursor: pointer;
    }

    .top_bar_del{
        position: absolute; 
        top:0px; left:10px;
        cursor: pointer;
    }

    .del_mess_contenta{
        font-style: italic;
        color:red;
    }

    .message_me{
        background-color:rgb(123, 180, 230); 
        margin-left:auto;
        /*border: 2px solid rgb(123, 180, 230);*/
        border-radius: 20px 20px 0px 20px;
    }

    .popup_overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
        z-index: 999;  /* Layer above the main content */
        cursor: not-allowed;  /* Optional: Change cursor to indicate no interaction */
    }

</style>
</head>



<div id="chat-container">
    <div id="chat-messages">
        <div class="option_div_main darkcolorchanger3" id="option_div_main_pin_poll" onclick="scrollToMessage('{{pinned_message}}')" >
            <p class="top_bar">A message was pinned</p>
            <p class="top_bar_close" onclick="closePinBar(event)">&#10006;</p>
        </div>
        {{#if polldata}}
            <div class="option_div_main2 darkcolorchanger3" id="option_div_main_pin_poll_poll" onclick="showPoll()" >
                {{#compare polldata.polledUser "===" userId}}
                    <p class="top_bar_del" onclick="deletePoll(event,'{{userId}}')"><i class="fa-solid fa-trash" style="font-size: 16px;"></i></p>
                {{/compare}}
                <p class="top_bar">A poll was raised</p>
                <p class="top_bar_close" onclick="closePollBar(event)">&#10006;</p>
            </div>
        {{/if}}

        <div id="new_mess_container">
            {{!-- This is where new messages will be appended --}}
        </div>
        <div id="loadingIndicator" style="display:none; text-align: center;">
            <!-- Your loading indicator (spinner, text, etc.) -->
            <p>Loading...</p>
        </div>
        {{#each messages}}
            {{#if this.last_notification}}
                <div class="new_notification_group darkcolorchanger2" id="last_message_scroll" data-message-id="{{this.MessageId}}">
                    <p class="p_new_notification">New Notifications</p>
                </div>
            {{/if}}
            <div class="message {{#compare this.userId "===" ../userId}} message_me {{/compare}}" 
            id="{{this.MessageId}}" onmousedown="startPressTimer('{{this.MessageId}}')" onmouseup="handlePressRelease()" onmouseleave="handlePressRelease()" 
            ontouchstart="startPressTimer('{{this.MessageId}}')" ontouchend="handlePressRelease()">
               
               {{#unless this.deleteStatus}}
                <div class="option_div" onclick="view_mess_options('{{this.MessageId}}',event)">
                    <i class="fa-solid fa-ellipsis" style="font-size: 22px;"></i>
                    <div class="dropdownND" id="dropdown-{{this.MessageId}}">
                        <ul>
                            <li onclick="showEmojiPopup('{{this.MessageId}}',event)">React</li>
                            {{#compare this.userId "===" ../userId}}
                                {{#compare this.MessageId "===" ../pinned_message}}
                                    <li onclick="unpin('{{this.MessageId}}')">Unpin</li>
                                {{else}}
                                    <li onclick="pin('{{this.MessageId}}')">Pin</li>
                                {{/compare}}
                            <li onclick="deleteMessage('{{this.MessageId}}')">Delete</li>
                            {{/compare}}
                        </ul>
                    </div>
                </div>
                {{/unless}}

                <div class="emoji-popup right_color_box" id="emoji-popup-{{this.MessageId}}">
                    <span onclick="selectEmoji('{{this.MessageId}}', '{{this.reactionCount}}', '{{stringify this.reactions}}', 'üòÄ')">üòÄ</span>
                    <span onclick="selectEmoji('{{this.MessageId}}', '{{this.reactionCount}}', '{{stringify this.reactions}}', 'üòÇ')">üòÇ</span>
                    <span onclick="selectEmoji('{{this.MessageId}}', '{{this.reactionCount}}', '{{stringify this.reactions}}', 'üòç')">üòç</span>
                    <span onclick="selectEmoji('{{this.MessageId}}', '{{this.reactionCount}}', '{{stringify this.reactions}}', 'üëç')">üëç</span>
                    <span onclick="selectEmoji('{{this.MessageId}}', '{{this.reactionCount}}', '{{stringify this.reactions}}', '‚ù§Ô∏è')">‚ù§Ô∏è</span>
                    <span onclick="selectEmoji('{{this.MessageId}}', '{{this.reactionCount}}', '{{stringify this.reactions}}', 'üò¢')">üò¢</span>
                    <span class="close-btn" onclick="closeEmojiPopup('{{this.MessageId}}',event)">‚úñ</span>
                </div>

                <div class="user-circle">
                    <a style="text-decoration: none;" {{#compare this.SENDBY '===' "USER"}} href="javascript:void(0)" onclick="viewProfile('{{this.userId}}')" {{/compare}}>
                        <img class="user-image profileImageAlternate" src="/user-images/{{this.userId}}.jpg" alt="User Image" draggable="false">
                    </a>
                </div>

                <div style="display: flex; flex-direction: column; width: 100%;">
                    {{#compare this.status "===" "textmessage"}}
                        {{#compare this.actualMessageId "!=" ""}}
                            <div class="reply darkcolorchanger3" style="margin-bottom: -25px;" onclick="scrollToMessage('{{this.actualMessageId}}')"><span class="repliedTO">replied to : </span><p class="replytext">{{this.actualMessageContent}}</p></div>
                        {{/compare}}
                    {{/compare}}
                    
                    <a style="text-decoration: none;color:black" {{#compare this.SENDBY '===' "USER"}} href="javascript:void(0)" onclick="viewProfile('{{this.userId}}')"{{/compare}}>
                        <div class="user-name">{{this.Name}}</div>
                    </a>

                    {{#compare this.status "===" "multimedia"}}
                        <div class="grid-container extra-items" style="margin-bottom: -30px;">
                            {{#if this.ImageNames}}
                                {{#each this.ImageNames}}
                                    <div class="grid-item image-item" data-src="/group-media/{{../userId}}/{{../MessageId}}/{{this}}" onclick="SEEMOREPOPUP_Specific('{{this}}','{{../this.MessageId}}','{{../this.userId}}','IMAGE')">
                                        <img class="preview" alt="Image {{@index}}">
                                    </div>
                                {{/each}}
                            {{/if}}

                            {{#if this.VideoNames}}
                                {{#each this.VideoNames}}
                                    <div class="grid-item video-item" data-src="/group-media/{{../userId}}/{{../MessageId}}/{{this}}" onclick="SEEMOREPOPUP_Specific('{{this}}','{{../this.MessageId}}','{{../this.userId}}','VIDEO')">
                                        <video class="preview" controls>
                                            <source src="" type="video/mp4">
                                        </video>
                                    </div>
                                {{/each}}
                            {{/if}}

                            {{#if (gt (add (length this.ImageNames) (length this.VideoNames)) 3)}}
                                <div class="grid-item see-more-item hidden">
                                    <div class="see-more-overlay">
                                        <button class="see-more-button" 
                                            onclick="SEEMOREPOPUP('{{ImageNames}}', '{{VideoNames}}','{{this.MessageId}}','{{this.userId}}')">See more
                                        </button>
                                    </div>
                                </div>
                            {{/if}}
                        </div>
                    {{/compare}}

                    <div id="message_content_{{this.MessageId}}"
                        class="actual-message {{#compare this.deleteStatus "===" "deletedMessage"}} del_mess_contenta{{/compare}} ">
                        <div class="message_content_class" id="Message_Content_ID_{{this.MessageId}}">
                            {{{this.messageContent}}}
                        </div>
                        <a href="javascript:void(0)" class="show_more" id="show_more_{{this.MessageId}}" onclick="toggleMessageContent('{{this.MessageId}}')">Show More</a>
                    </div> 

                    <div class="reply_del_div">
                        {{#unless this.deleteStatus}}
                            <button class="reply_link" onclick="replyToMessage('{{this.MessageId}}','{{this.messageContent}}','{{this.Name}}')"><i class="fa-solid fa-reply" style="padding: 0px;"></i></button>
                        {{/unless}}
                    </div>
                    {{#compare this.deleteStatus "===" "deletedMessage" }}
                        <p class="post_time">{{this.formattedTime}}</p>
                        <p class="delete_time">{{this.formattedDeletedTime}}</p>
                    {{/compare}}
                    {{#unless this.deleteStatus}}
                        <p class="no_delete_time">{{this.formattedTime}}</p>
                    {{/unless}}
                </div>

                {{#unless this.deleteStatus}}
                {{#if this.reactions}}
                    <div class="reaction_div" onclick="view_mess_reactionss('{{this.MessageId}}')">
                        <div class="reaction_thumb"><span class="count_reaction">{{this.reactions.length}}</span>{{getLastReaction this.reactions}}</div>
                    </div>
                {{/if}}
                {{/unless}}
                <section>
                    <div id="view_reactions_{{this.MessageId}}" class="popupform_view_reactions right_color_box">
                        <p class="reaction_hidden_time">{{this.formattedTime}}</p>                                                
                        <p class="close_pop_up_view_reactions" onclick="closePopupViewReactions('{{this.MessageId}}')">&#10006;</p>
                        <div class="Reaction_body_turnedon" style="margin-top: 50px;">
                            {{#each this.reactions}}
                                <div class="reaction_divider">
                                    <div class="user_circle" style="display: flex;">
                                        <a style="text-decoration: none;cursor:pointer;" {{#compare this.user_Name "!==" "Admin"}} href="javascript:void(0)" onclick="viewProfile('{{this.user_id}}')"{{/compare}}>
                                            <img class="user_image profileImageAlternate" src="/user-images/{{this.user_id}}.jpg" alt="User Image" draggable="false">
                                        </a>
                                    </div>
                                    <a style="text-decoration: none;display: flex;" {{#compare this.user_Name "!==" "Admin"}} href="javascript:void(0)" onclick="viewProfile('{{this.user_id}}')"{{/compare}}>
                                        <p class="p_in_like_body_turnedon">{{this.user_Name}}</p>
                                    </a>
                                    <p class="p_emoji">{{this.emoji}}</p>
                                </div>
                            {{/each}}
                            <p class="bot_p_1 blackName">press on the emoji once more to remove</p>
                            <p class="bot_p_2 blackName">press on other emoji to modify your reaction</p>
                        </div>
                    </div>
                </section>
            </div>
        {{/each}}
    </div>

    <div id="loading-indicator">
        <div class="spinner"></div>
        <p>Sending...</p>
    </div>
    <div id="loading-indicator_loader">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <section>
        <div id="view_Poll" class="popupform_view_reactions right_color_box" style="height:auto;max-height:600px;overflow:auto;">
            <p style="position: absolute; top:5px; right:10px;cursor: pointer;" onclick="closePopupViewPoll()">&#10006;</p>
            <p style="font-size: 12px; margin-bottom:0px;margin-top:0px;">
                <span style="color: rgb(93, 138, 222);">
                    <a {{#compare polldata.polledUserName "!==" "Admin"}} onclick="viewProfile('{{polldata.polledUser}}')" {{/compare}}>{{polldata.polledUserName}}</a>
                </span>
            </p>
            <div class="Reaction_body_turnedon" style="margin-top: 20px;">
                <form id="pollForm">
                    <p class="poll_heading">{{polldata.caption}}</p>
                    {{#each polldata.options}}
                        <label>
                            <input type="checkbox" name="{{../polldata.Poll_Id}}" value="{{this}}"
                                {{#if (includes ../polldata.values this)}}checked{{/if}}
                                onclick="submitPoll('{{this}}','{{../polldata.Poll_Id}}')"> {{this}}
                        </label><br>
                    {{/each}}
                </form>
                <button type="button" class="btn view_vote" style="background-color: rgb(93, 138, 222); color:white" onclick="viewVotes()">view votes</button>
                <p style="font-size: 10px; margin-bottom:0px;margin-top:7px;">{{polldata.readable_poll_time}}</p>
            </div>
        </div>
    </section>

    <section>
        <div id="view_Plus_option" class="popupform_view_reactions right_color_box" >
            <div style="position: absolute; top:5px; right:10px">
                <span class="" style="cursor: pointer;" onclick="closePlusButtonOption()">&#10006;</span>
            </div>
            <div class="Reaction_body_turnedon" style="margin-top: 35px;">
                <button type="button" class="btn plus_button_option" onclick="initialize_poll()">initialize poll</button>
                <button type="button" class="btn plus_button_option" onclick="togglePostGroupChat()">send multimedia message</button>
            </div>
        </div>
    </section>

    <section>
        <div id="initialize_poll" class="popupform_initialize_poll right_color_box" >
            <div style="position: absolute; top:5px; right:10px">
                <span style="cursor: pointer;" onclick="closePollDiv()">&#10006;</span>
            </div>
            <div class="Reaction_body_turnedon" style="margin-top: 35px;">
                <form id="pollForm">
                    <textarea required id="caption_poll" placeholder="Enter your content. (100 letters)" class="init_poll_text" oninput="resizeTextarea(); enforceCharacterLimit(this, 100);"></textarea>
                    <!-- Container for poll options -->
                    <div id="optionsContainer" style="margin-top: 15px;"></div>
                    <!-- Add Options Button -->
                    <button type="button" id="addOptionBtn" class="add_opt_btn btn " onclick="addPollOption()">Add Option</button>
                </form>
                <button type="button" class="btn submit_poll_my darkcolorchanger3" onclick="InitializeMyPoll(event)">Submit</button>
                <p style="font-size: 11px; margin-bottom:0px;margin-top:7px;">polls will be automatically deleted after 30 days</p>
            </div>
        </div>
    </section>

    <section>
        <div id="view_votes_section" class="popupform_view_reactions right_color_box" style="max-height:600px;height:auto;overflow:auto;">
            <div style="position: sticky; top:5px; right:10px">
                <span class="" style="cursor: pointer;" onclick="closeViewVotes()">&#10006;</span>
            </div>
            <div class="Reaction_body_turnedon" style="margin-top: 35px;">
                <!-- ITERATE OVER HERE --->
            </div>
        </div>
    </section>

    <div id="chat-form">
        <input type="hidden" id="actualMessageId" name="actualMessageId" value="">
        <input type="hidden" id="actualMessageUsername" name="actualMessageUsername" value="">
        <textarea style="display: none;" type="hidden" id="actualMessageContent" name="actualMessageContent" value=""></textarea>
        <textarea id="message-input" name="messageContent" rows="2" placeholder="Type your message" oninput="limitCharacters(this, 3000);" required></textarea>
         <button id="send-button" class="darkcolorchanger2" onclick="return sendMessage()">Send</button>
        <a href="javascript:void(0)" onclick="plus_button_options()"> 
            <button class="button_plus btn" type="button">+</button>
        </a>
    </div>

    <div id="post-groupchat-container" class="popup-form" style="display: none;">
        <div style="width:100%" class="rows">
            <div id="uploadForm" class="darkcolorchanger2" style="width:100%;">
                <p class="close_pop_up" style="cursor: pointer;margin-bottom:0px;position:absolute;top:2px;right:10px;" onclick="closePopup()">&#10006;</p>
                <form class="formpostgroup" id="postForm" enctype="multipart/form-data">
                    <div id="imageCarousel" class="carousel slide" data-ride="carousel">
                        <div class="carousel-inner" id="previewContainer"></div>
                        <a class="carousel-control-prev" href="#imageCarousel" role="button" data-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="sr-only">Previous</span>
                        </a>
                        <a class="carousel-control-next" href="#imageCarousel" role="button" data-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="sr-only">Next</span>
                        </a>
                    </div>

                    <div class="custom-file-upload" style="margin-top: 20px;">
                        <div>
                            <i class="fas fa-cloud-upload-alt"></i> <span style="font-weight: 500;font-size:13px;"> Image/Video</span>
                            <img src="" alt="" style="width:100px;" id="userView">
                            <input class="inputpostgroup" style="color: black;" type="file" id="postImage" required name="postImage" accept="image/*,video/*" multiple onchange="viewpImage(event)">
                        </div>
                    </div>

                    <textarea class="custom_text_area_postgroup textareapostgroup" id="message-input-group-post" name="messageContent" rows="3" placeholder="type your message....." oninput="resizeTextarea(); limitCharacters(this, 3000);"></textarea>

                    <div class="form-group" style="display: none;">
                        <label class="labelpostgroup"><strong>Send by</strong></label><br>
                        <input class="form-control inputpostgroup" name="SENDBY" value="USER">
                    </div>

                    <button class="buttonpostgroup" type="submit" onclick="sendMessageGroupPost(event)">Send</button>
                </form> 
            </div>
        </div>
    </div>

    <div id="seemore_popup" class="popupform_seemore " style="display: none;">
        <div style="width:100%" class="rows">
            <div id="seemore_popup_form" class="right_color_box" style="width:100%;">
                <div style="text-align: right; margin-right: 10px;">
                    <span class="close_pop_up" style="cursor: pointer;" onclick="closePopupSeeMore()">&#10006;</span>
                </div>
                <div id="media_content" style="text-align: center;"></div>
                    <!-- Container for images and videos -->
            </div>
        </div>
    </div>

</div>
 

 <script src="http://localhost:3001/socket.io/socket.io.js"></script>
 <script>
    const messageInput = document.getElementById('message-input');
    const actualMessageId = document.getElementById('actualMessageId');
    const actualMessageContent = document.getElementById('actualMessageContent');
    const actualMessageUserName = document.getElementById('actualMessageUsername');
    const myID = '{{userId}}';
    const myName = '{{uber}}';
    let pinned_message = '{{pinned_message}}';
    localStorage.setItem("PinMessageLocally", pinned_message);
    sessionStorage.setItem("limiter", '{{limit}}');
    var skip = sessionStorage.getItem('limiter'); 
    const chatContainer = document.getElementById("chat-messages");

    const socket = io('http://localhost:3001'); 


    socket.on('chatMessage', (data) => {
        displayMessage(data);
    });


    socket.on('chatMessageEmoji', (data) => {
        //console.log("chatMessageEmoji event received at client:", data);
        updateMessageContentInDOM(data);
    });


    socket.on('chatMultimediaMessage', (data) => {
        //console.log("chatMultimediaMessage event received at client:", data);
        displayMultiMessage(data);
    });

    
    socket.on('chatMessagepin', (data) => {
        //console.log("Pin event received at client:", data);
        doThePin(data);
    });


    socket.on('chatMessageUnpin', () => {
        //console.log("Unpin event received at client");
        doTheUnpin();
    });
    

    socket.on('deleteMessage', (data) => {
        //console.log("deleteMessage event received at client:", data);
        const deletedMessage = document.getElementById(data.messageId);
        if (deletedMessage) {
            deletedMessage.remove();
        }
    });

    
    socket.on('deletePoll', () => {
        const deletedPoll = document.getElementById("option_div_main_pin_poll_poll");
        if (deletedPoll) {
            deletedPoll.style.display = "none";
        }
    });


    function displayMessage(data) {
        //console.log("DATA TEXT : ",data)
        
        const  darkEnabler = localStorage.getItem('darkModeARCCEC') === 'enabled';
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message');
        if (data.userId === myID) {
           messageContainer.classList.add('message_me');
        }
        messageContainer.id = data.Message_ID;
        messageContainer.setAttribute('onmousedown', `startPressTimer('${data.Message_ID}')`);
        messageContainer.setAttribute('onmouseup', 'handlePressRelease()');
        messageContainer.setAttribute('onmouseleave', 'handlePressRelease()');
        messageContainer.setAttribute('ontouchstart', `startPressTimer('${data.Message_ID}')`);
        messageContainer.setAttribute('ontouchend', 'handlePressRelease()');

        const timestampPara = document.createElement('p');
        timestampPara.classList.add('no_delete_time');
        timestampPara.textContent = data.timestamp;

        const optionDiv = document.createElement('div');
        optionDiv.classList.add('option_div');
        optionDiv.setAttribute('onclick', `view_mess_options('${data.Message_ID}', event)`);

        const ellipsisIcon = document.createElement('i');
        ellipsisIcon.classList.add('fa-solid', 'fa-ellipsis');
        ellipsisIcon.style.fontSize = '22px';

        const dropdown = document.createElement('div');
        dropdown.classList.add('dropdownND');
        dropdown.id = `dropdown-${data.Message_ID}`;

        const ul = document.createElement('ul');
        const reactLi = document.createElement('li');
        reactLi.setAttribute('onclick', `showEmojiPopup('${data.Message_ID}', event)`);
        reactLi.textContent = 'React';

        ul.appendChild(reactLi);

        if (data.userId === myID) {

            const pinLi = document.createElement('li');
            pinLi.setAttribute('onclick', `pin('${data.Message_ID}')`);
            pinLi.textContent = 'Pin';

            const deleteLi = document.createElement('li');
            deleteLi.setAttribute('onclick', `deleteMessage('${data.Message_ID}')`);
            deleteLi.textContent = 'Delete';

            ul.appendChild(pinLi);
            ul.appendChild(deleteLi);
        }

        dropdown.appendChild(ul);
        optionDiv.appendChild(ellipsisIcon);
        optionDiv.appendChild(dropdown);
        messageContainer.appendChild(optionDiv);

        const emojiPopup = document.createElement('div');
        emojiPopup.classList.add('emoji-popup','right_color_box');
        if(darkEnabler){
            emojiPopup.style.background = 'linear-gradient(#fff, #606060)';
        }
        emojiPopup.id = `emoji-popup-${data.Message_ID}`;

        const emojis = ['üòÄ', 'üòÇ', 'üòç', 'üëç', '‚ù§Ô∏è', 'üò¢'];
        emojis.forEach(emoji => {
            const span = document.createElement('span');
            span.setAttribute('onclick', `selectEmoji('${data.Message_ID}', null, null,'${emoji}')`);
            span.textContent = emoji;
            emojiPopup.appendChild(span);
        });

        const closeBtn = document.createElement('span');
        closeBtn.classList.add('close-btn');
        closeBtn.setAttribute('onclick', `closeEmojiPopup('${data.Message_ID}', event)`);
        closeBtn.textContent = '‚úñ';
        emojiPopup.appendChild(closeBtn);

        messageContainer.appendChild(emojiPopup);

        const userCircle = document.createElement('div');
        userCircle.classList.add('user-circle');

        const userImageLink = document.createElement('a');
        userImageLink.style.textDecoration = 'none';
        if(data.SEND_BY == "USER"){
            userImageLink.setAttribute('onclick', `viewProfile('${data.userId}')`);
        }

        const userImage = document.createElement('img');
        userImage.classList.add('user-image');
        userImage.src = `/user-images/${data.userId}.jpg`;
        userImage.alt = 'User Image';

        userImage.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // Prevent dragging
        userImage.addEventListener('dragstart', function(e) {
            e.preventDefault();
        });

        // Profile image fallback handling
        fetch(userImage.src)
            .then(response => {
                if (!response.ok) {
                    userImage.src = "/user-images/user.png";
                }
            })
            .catch(error => {
                console.error("Error fetching image:", error);
                userImage.src = "/user-images/user.png";
            });

        userImageLink.appendChild(userImage);
        userCircle.appendChild(userImageLink);

        const messageContentContainer = document.createElement('div');
        messageContentContainer.style.display = 'flex';
        messageContentContainer.style.flexDirection = 'column';
        messageContentContainer.style.width = '100%';

        if (data.RE_messageId || data.RE_messageContent) {
            /*const replyDiv = document.createElement('div');
            replyDiv.classList.add('reply');
            replyDiv.style.marginBottom = '-20px';
            replyDiv.textContent = `replied to: ${data.RE_messageContent}`;
            replyDiv.setAttribute('onclick', `scrollToMessage('${data.RE_messageId}')`);
            messageContentContainer.appendChild(replyDiv);*/



            const replyDiv = document.createElement('div');
            replyDiv.classList.add('reply','darkcolorchanger3');
            replyDiv.style.marginBottom = '-25px';
            if(darkEnabler){
                replyDiv.style.backgroundColor = 'black';
                replyDiv.style.color = 'white';
            }
            replyDiv.setAttribute('onclick', `scrollToMessage('${data.RE_messageId}')`);

            // Create the 'repliedTO' span element
            const repliedToSpan = document.createElement('span');
            repliedToSpan.classList.add('repliedTO');
            repliedToSpan.textContent = 'replied to : ';

            // Create the 'replytext' p element
            const replyTextP = document.createElement('p');
            replyTextP.classList.add('replytext');
            replyTextP.textContent = data.RE_messageContent; // Set the reply message content

            // Append the 'repliedTO' span and 'replytext' p elements to the replyDiv
            replyDiv.appendChild(repliedToSpan);
            replyDiv.appendChild(replyTextP);

            // Append the entire replyDiv to the message content container
            messageContentContainer.appendChild(replyDiv);
        }

        const userNameLink = document.createElement('a');
        userNameLink.style.textDecoration = 'none';
        userNameLink.style.color = 'black';
        if(data.SEND_BY == "USER"){
            userNameLink.setAttribute('onclick', `viewProfile('${data.userId}')`);
        }

        const userName = document.createElement('div');
        userName.classList.add('user-name');
        userName.textContent = data.Name;

        userNameLink.appendChild(userName);
        messageContentContainer.appendChild(userNameLink);

        const actualMessage = document.createElement('div');
        actualMessage.classList.add('actual-message');

        actualMessage.id = `message_content_${data.Message_ID}`;
        const messageContentDiv = document.createElement('div');
        messageContentDiv.classList.add('message_content_class');
        messageContentDiv.id = `Message_Content_ID_${data.Message_ID}`;
        messageContentDiv.innerHTML = data.message;
        actualMessage.appendChild(messageContentDiv);

        // Create the "Show More" link
        const showMoreLink = document.createElement('a');
        showMoreLink.href = 'javascript:void(0)';
        showMoreLink.classList.add('show_more');
        showMoreLink.id = `show_more_${data.Message_ID}`;
        showMoreLink.textContent = 'Show More';
        showMoreLink.onclick = function() { toggleMessageContent(data.Message_ID); };

        actualMessage.appendChild(showMoreLink);

        /*if (data.yesDelete) {
            actualMessage.style.fontStyle = 'italic';
            actualMessage.style.color = 'red';
        }*/

        const replyDelDiv = document.createElement('div');
        replyDelDiv.classList.add('reply_del_div');

        const replyButton = document.createElement('button');
        replyButton.classList.add('reply_link');
        replyButton.setAttribute('onclick', `replyToMessage('${data.Message_ID}', '${data.message}', '${data.Name}')`);
        replyButton.innerHTML = '<i class="fa-solid fa-reply" style="padding: 0px;"></i>';
        replyDelDiv.appendChild(replyButton);

        /*if (data.yesDelete) {
            const deleteTimePara = document.createElement('p');
            deleteTimePara.classList.add('delete_time');
            if (data.delete) {
                deleteTimePara.style.color = 'rgb(78, 74, 74)';
            }
            deleteTimePara.textContent = `deleted time: ${data.deleted_time}`;
            replyDelDiv.appendChild(deleteTimePara);
        }*/
        

        messageContentContainer.appendChild(actualMessage);
        messageContentContainer.appendChild(replyDelDiv);
        messageContentContainer.appendChild(timestampPara);
        messageContainer.appendChild(userCircle);
        messageContainer.appendChild(messageContentContainer);
        chatContainer.appendChild(messageContainer);
        checkContentOverflow(data.Message_ID);

        // Check if the current scroll position is near the bottom
        const isNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop <= chatContainer.clientHeight + 380;

        if (data.userId === myID){  
            scrollToBottom();
        } else{
            // Alert the user about new messages if not near the bottom
            if (!isNearBottom) {
                alert('You have new groupchat messages.');
            }

            // Scroll to bottom only if the current scroll position is near the bottom
            if (isNearBottom) {
                scrollToBottom();
            }
        }
    }


    function displayMultiMessage(data) {
        //console.log("DATA MULTI : ",data)

        const  darkEnabler = localStorage.getItem('darkModeARCCEC') === 'enabled';
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message');
        if (data.message.userId === myID) {
           messageContainer.classList.add('message_me');
        }
        messageContainer.id = data.message.MessageId; // Accessing MessageId from data.message
        messageContainer.setAttribute('onmousedown', `startPressTimer('${data.message.MessageId}')`);
        messageContainer.setAttribute('onmouseup', 'handlePressRelease()');
        messageContainer.setAttribute('onmouseleave', 'handlePressRelease()');
        messageContainer.setAttribute('ontouchstart', `startPressTimer('${data.message.MessageId}')`);
        messageContainer.setAttribute('ontouchend', 'handlePressRelease()');

        const timestampPara = document.createElement('p');
        timestampPara.classList.add('no_delete_time');
        timestampPara.textContent = data.message.formattedTime;

        const optionDiv = document.createElement('div');
        optionDiv.classList.add('option_div');
        optionDiv.setAttribute('onclick', `view_mess_options('${data.message.MessageId}', event)`);

        const ellipsisIcon = document.createElement('i');
        ellipsisIcon.classList.add('fa-solid', 'fa-ellipsis');
        ellipsisIcon.style.fontSize = '22px';

        const dropdown = document.createElement('div');
        dropdown.classList.add('dropdownND');
        dropdown.id = `dropdown-${data.message.MessageId}`;

        const ul = document.createElement('ul');
        const reactLi = document.createElement('li');
        reactLi.setAttribute('onclick', `showEmojiPopup('${data.message.MessageId}', event)`);
        reactLi.textContent = 'React';

        ul.appendChild(reactLi);

        if (data.message.userId=== myID) {

            const pinLi = document.createElement('li');
            pinLi.setAttribute('onclick', `pin('${data.message.MessageId}')`);
            pinLi.textContent = 'Pin';

            const deleteLi = document.createElement('li');
            deleteLi.setAttribute('onclick', `deleteMessage('${data.message.MessageId}')`);
            deleteLi.textContent = 'Delete';

            ul.appendChild(pinLi);
            ul.appendChild(deleteLi);
        }

        dropdown.appendChild(ul);
        optionDiv.appendChild(ellipsisIcon);
        optionDiv.appendChild(dropdown);
        messageContainer.appendChild(optionDiv);

        const emojiPopup = document.createElement('div');
        emojiPopup.classList.add('emoji-popup','right_color_box');
        if(darkEnabler){
            emojiPopup.style.background = 'linear-gradient(#fff, #606060)';
        }
        emojiPopup.id = `emoji-popup-${data.message.MessageId}`;

        const emojis = ['üòÄ', 'üòÇ', 'üòç', 'üëç', '‚ù§Ô∏è', 'üò¢'];
        emojis.forEach(emoji => {
            const span = document.createElement('span');
            span.setAttribute('onclick', `selectEmoji('${data.message.MessageId}', null, null, '${emoji}')`);
            span.textContent = emoji;
            emojiPopup.appendChild(span);
        });

        const closeBtn = document.createElement('span');
        closeBtn.classList.add('close-btn');
        closeBtn.setAttribute('onclick', `closeEmojiPopup('${data.message.MessageId}', event)`);
        closeBtn.textContent = '‚úñ';
        emojiPopup.appendChild(closeBtn);

        messageContainer.appendChild(emojiPopup);

        const userCircle = document.createElement('div');
        userCircle.classList.add('user-circle');

        const userImageLink = document.createElement('a');
        userImageLink.style.textDecoration = 'none';
        if(data.message.SENDBY == "USER"){
            userImageLink.setAttribute('onclick', `viewProfile('${data.message.userId}')`);
        }

        const userImage = document.createElement('img');
        userImage.classList.add('user-image');
        userImage.src = `/user-images/${data.message.userId}.jpg`;
        userImage.alt = 'User Image';

        userImage.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // Prevent dragging
        userImage.addEventListener('dragstart', function(e) {
            e.preventDefault();
        });

        userImageLink.appendChild(userImage);
        userCircle.appendChild(userImageLink);

        // Profile image fallback handling
        fetch(userImage.src)
            .then(response => {
                if (!response.ok) {
                    userImage.src = "/user-images/user.png";
                }
            })
            .catch(error => {
                console.error("Error fetching image:", error);
                userImage.src = "/user-images/user.png";
            });

        const messageContentContainer = document.createElement('div');
        messageContentContainer.style.display = 'flex';
        messageContentContainer.style.flexDirection = 'column';
        messageContentContainer.style.width = '100%';

        //    CAN BE USED
        /*if (data.message.actualMessageId && data.message.actualMessageId !== "" &&  data.message.actualMessageContent !== "") {
            const replyDiv = document.createElement('div');
            replyDiv.classList.add('reply');
            replyDiv.style.marginBottom = '-20px';
            replyDiv.textContent = `replied to: ${data.message.actualMessageContent}`;
            replyDiv.setAttribute('onclick', `scrollToMessage('${data.message.actualMessageId}')`);
            messageContentContainer.appendChild(replyDiv);
        }*/

        const userNameLink = document.createElement('a');
        userNameLink.style.textDecoration = 'none';
        userNameLink.style.color = 'black';
        if(data.message.SENDBY == "USER"){
            userNameLink.setAttribute('onclick', `viewProfile('${data.message.userId}')`);

        }

        const userName = document.createElement('div');
        userName.classList.add('user-name');
        userName.textContent = data.message.Name;

        userNameLink.appendChild(userName);
        messageContentContainer.appendChild(userNameLink);

        const actualMessage = document.createElement('div');
        actualMessage.classList.add('actual-message');

        actualMessage.id = `message_content_${data.message.MessageId}`;
        const messageContentDiv = document.createElement('div');
        messageContentDiv.classList.add('message_content_class');
        messageContentDiv.id = `Message_Content_ID_${data.message.MessageId}`;
        messageContentDiv.innerHTML = data.message.messageContent;
        actualMessage.appendChild(messageContentDiv);

        // Create the "Show More" link
        const showMoreLink = document.createElement('a');
        showMoreLink.href = 'javascript:void(0)';
        showMoreLink.classList.add('show_more');
        showMoreLink.id = `show_more_${data.message.MessageId}`;
        showMoreLink.textContent = 'Show More';
        showMoreLink.onclick = function() { toggleMessageContent(data.message.MessageId); };

        actualMessage.appendChild(showMoreLink);

        /*if (data.message.yesDelete) {
            actualMessage.style.fontStyle = 'italic';
            actualMessage.style.color = 'red';
        }*/

        // Adding multimedia content
        if (data.message.status === "multimedia") {
            const gridContainer = document.createElement('div');
            gridContainer.classList.add('grid-container', 'extra-items');
            gridContainer.style.marginBottom = '-30px';

            if (data.message.ImageNames) {
                data.message.ImageNames.forEach(image => {
                    const imageItem = document.createElement('div');
                    imageItem.classList.add('grid-item', 'image-item');
                    imageItem.dataset.src = `/group-media/${data.message.userId}/${data.message.MessageId}/${image}`;
                    imageItem.setAttribute('onclick', `SEEMOREPOPUP_Specific('${image}', '${data.message.MessageId}', '${data.message.userId}', 'IMAGE')`);

                    const img = document.createElement('img');
                    img.classList.add('preview');
                    img.src = `/group-media/${data.message.userId}/${data.message.MessageId}/${image}`;
                    img.alt = 'Image';

                    imageItem.appendChild(img);
                    gridContainer.appendChild(imageItem);
                });
            }

            if (data.message.VideoNames) {
                data.message.VideoNames.forEach(video => {
                    const videoItem = document.createElement('div');
                    videoItem.classList.add('grid-item', 'video-item');
                    videoItem.dataset.src = `/group-media/${data.message.userId}/${data.message.MessageId}/${video}`;
                    videoItem.setAttribute('onclick', `SEEMOREPOPUP_Specific('${video}', '${data.message.MessageId}', '${data.message.userId}', 'VIDEO')`);

                    const videoElement = document.createElement('video');
                    videoElement.classList.add('preview');
                    videoElement.controls = true;

                    const source = document.createElement('source');
                    source.src = `/group-media/${data.message.userId}/${data.message.MessageId}/${video}`;
                    source.type = 'video/mp4';

                    videoElement.appendChild(source);
                    videoItem.appendChild(videoElement);
                    gridContainer.appendChild(videoItem);
                });
            }

            if (data.message.ImageNames && data.message.VideoNames && (data.message.ImageNames.length + data.message.VideoNames.length > 3)) {
                const seeMoreItem = document.createElement('div');
                seeMoreItem.classList.add('grid-item', 'see-more-item', 'hidden');

                const seeMoreOverlay = document.createElement('div');
                seeMoreOverlay.classList.add('see-more-overlay');

                const seeMoreButton = document.createElement('button');
                seeMoreButton.classList.add('see-more-button');
                seeMoreButton.setAttribute('onclick', `SEEMOREPOPUP('${data.message.ImageNames}', '${data.message.VideoNames}', '${data.message.MessageId}', '${data.message.userId}')`);
                seeMoreButton.textContent = 'See more';

                seeMoreOverlay.appendChild(seeMoreButton);
                seeMoreItem.appendChild(seeMoreOverlay);
                gridContainer.appendChild(seeMoreItem);
            }

            messageContentContainer.appendChild(gridContainer);
        }

        const replyDelDiv = document.createElement('div');
        replyDelDiv.classList.add('reply_del_div');

        const replyButton = document.createElement('button');
        replyButton.classList.add('reply_link');
        if (!data.message.deleteStatus || !data.message.deleteStatus !== "deletedMessage") {
            replyButton.setAttribute('onclick', `replyToMessage('${data.message.MessageId}', '${data.message.messageContent}', '${data.message.Name}')`);
        }
        replyButton.innerHTML = '<i class="fa-solid fa-reply" style="padding: 0px;"></i>';
        replyDelDiv.appendChild(replyButton);

        messageContentContainer.appendChild(actualMessage);
        messageContentContainer.appendChild(replyDelDiv);
        messageContentContainer.appendChild(timestampPara);
        messageContainer.appendChild(userCircle);
        messageContainer.appendChild(messageContentContainer);
        chatContainer.appendChild(messageContainer);
        checkContentOverflow(data.message.MessageId);

        // Check if the current scroll position is near the bottom
        const isNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop <= chatContainer.clientHeight + 380;

        if (data.message.userId=== myID){  
            scrollToBottom();
        } else{
            // Alert the user about new messages if not near the bottom
            if (!isNearBottom) {
                alert('You have new groupchat messages.');
            }

            // Scroll to bottom only if the current scroll position is near the bottom
            if (isNearBottom) {
                scrollToBottom();
            }
        }
    }


    async function sendMessage() {
        const Message_ID = generateUniqueId();
        var message = messageInput.value.trim();
        const RE_messageId = actualMessageId.value;
        const RE_messageContent = actualMessageContent.value;
        const RE_userName = actualMessageUserName.value;
        const SEND_BY = "USER";
        const timestamp = new Date();
        const formattedTimestamp = new Date(timestamp).toLocaleTimeString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' });

        replyToMessageId = null;
        replytoMessage = null;
        actualMessageId.value = '';
        actualMessageContent.value = '';
        actualMessageUserName.value = '';
        updateundoPlaceholder('Type your message');
        
            if (message !== '') {

            message = message.replace(/[\r\n]+/g, " ").replace(/\s+/g, ' ').trim();

            document.getElementById('message-input').value = '';
            document.getElementById('message-input').style.height = '10px';

            try {
                const response = await $.ajax({
                    url: '/send-message',
                    method: 'post',
                    data: {
                        MessageId: Message_ID,
                        actualMessageId: RE_messageId,
                        actualMessageUsername: RE_userName,
                        SENDBY: SEND_BY,
                        actualMessageContent: RE_messageContent,
                        messageContent: message,
                        formattedTimestamp: formattedTimestamp
                    }
                });

                if (response.addedGroupMessage) {
                    // Fetch the updated message data
                    const updatedMessageResponse = await $.ajax({
                        url: '/get_message_by_id_text',
                        method: 'POST',
                        data: {
                            MeSsAgEiD: Message_ID,
                        }
                    });

                    if (updatedMessageResponse.message.has_message) {
                        //console.log("MESSAGE VALID : ", updatedMessageResponse.message);
                        //await appendMessage(updatedMessageResponse.message);
                        // TO DISPLAY MESSAGE USING WEBSOCKET AFTER SUCCESSFULL EXECUTION OF DATABASE MESSAGE INSERTION
                        await socket.emit('chatMessage', { userId: myID, Name: myName, Message_ID, message, RE_messageId, RE_messageContent, RE_userName, SEND_BY, timestamp: formattedTimestamp });
                        await scrollToBottom()
                    }
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }
    }


    async function sendMessageGroupPost(event) {
        event.preventDefault();

        const popup_form = document.getElementById('post-groupchat-container');
        popup_form.style.display = "none";
        
        const form = document.getElementById('postForm');
        const formData = new FormData(form);
        
        const postImageInput = document.getElementById('postImage');
        if (postImageInput.files.length === 0) {
            alert('Please select an image or video.');
            var overlay = document.getElementById('plus_button_option_overlay');
            if (overlay) {
                overlay.remove();
            }
            chatContainer.style.overflow = 'auto';
            return;
        }
        
        // Show the loading indicator
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.style.display = 'block';
        chatContainer.style.overflow = "hidden";
        
        const newMessageId = generateUniqueId();
        formData.append('MessageId', newMessageId);
        const url = '/add-post-togroup';
        const method = 'POST';
        
        try {
            const response = await $.ajax({
                url: url,
                method: method,
                data: formData,
                processData: false,
                contentType: false,
            });
            
            if (response.addedGroupPostMessage) {
                const updatedMessageResponse = await $.ajax({
                    url: '/get_message_by_id',
                    method: 'POST',
                    data: {
                        MeSsAgEiD: newMessageId,
                    }
                });

                if (updatedMessageResponse.message) {
                    await socket.emit('chatMultimediaMessage', { message: updatedMessageResponse.message });
                    await scrollToBottom();
                }
            } else {
                console.error('Failed to upload post:', response.message);
            }
        } catch (error) {
            console.error('Error uploading post:', error);
        } finally {
            // Hide the loading indicator
            loadingIndicator.style.display = 'none';
            chatContainer.style.overflow = "auto";
            
            // Reset the form to its initial state
            form.reset();

            // Clear preview container
            document.getElementById('previewContainer').innerHTML = '';

            // Clear userView image source
            document.getElementById('userView').src = '';

            var overlay = document.getElementById('plus_button_option_overlay');
            if (overlay) {
                overlay.remove();
            }
            chatContainer.style.overflow = 'auto';
        }
    }


    document.addEventListener("DOMContentLoaded", function() {
        scrollToBottom();
        document.getElementById("message-input").focus();

        let option_div_main = document.getElementById('option_div_main_pin_poll')
        if(pinned_message && pinned_message != 0){
            option_div_main.style.display = 'flex';
        }
    });
    messageInput.addEventListener('input', autoResize);


    /*function updatePlaceholder() {
        messageInput.placeholder = `Reply to: ${replytoMessage}`;
        messageInput.focus();
    }*/


    function updatePlaceholder() {
        var ActualQuestion = `${replytoMessage}`
        var firstLine = ActualQuestion.split('\n')[0];
        var maxLength = 50; // Set a maximum length for the placeholder text
        if (firstLine.length > maxLength) {
            firstLine = firstLine.substring(0, maxLength) + "..."; // Truncate and add ellipsis if it's too long
        }
        messageInput.placeholder = "Reply to: " + firstLine;
        messageInput.focus();
    }


    function updateundoPlaceholder(placeholderText) {
        // Assuming 'message-input' is the ID of your message input field
        document.getElementById('message-input').placeholder = placeholderText;
    }


    function replyToMessage(messageId, messageText, actualMessageUsername) {
        //console.log("REPLY CALLED")
        replyToMessageId = messageId;
        replytoMessage = messageText;
        actualMessageId.value = messageId;
        actualMessageContent.value = messageText;
        actualMessageUserName.value = actualMessageUsername;
        updatePlaceholder();
    }


    function autoResize() {
        messageInput.style.height = 'auto';
        messageInput.style.height = (messageInput.scrollHeight) + 'px';
    }


    function deleteMessage(messageId) {
        if (confirm("Do you want to delete this message for everyone?")) {
            $.ajax({
            url: '/delete-message-from-groupchat',
            method: 'post',
            data: {
                MessagE: messageId,
            },
            success: function (response) {
                if (response.deleteMessage) {
                    const deleteEventData = { messageId };
                    socket.emit('deleteMessage', deleteEventData);
                }
            },
            });
        }
    }


    function SEEMOREPOPUP(imageNames, videoNames, messageID, userId) {
        const mediaContent = document.getElementById('media_content');
        
        // Clear previous content
        mediaContent.innerHTML = '';
        
        // Append images if imageNames is not empty
        if (imageNames) {
            const images = imageNames.split(',');
            images.forEach(image => {
                const imgElement = document.createElement('img');
                imgElement.src = `/group-media/${userId}/${messageID}/${image}`;
                imgElement.style.maxWidth = '100%'; // Adjust this as needed
                imgElement.style.margin = '10px 0'; // Adjust spacing as needed
                mediaContent.appendChild(imgElement);
            });
        }
        
        // Append videos if videoNames is not empty
        if (videoNames) {
            const videos = videoNames.split(',');
            videos.forEach(video => {
                const videoElement = document.createElement('video');
                const sourceElement = document.createElement('source');
                sourceElement.src = `/group-media/${userId}/${messageID}/${video}`;
                sourceElement.type = 'video/mp4';
                videoElement.controls = true;
                videoElement.style.maxWidth = '100%'; // Adjust this as needed
                videoElement.style.margin = '10px 0'; // Adjust spacing as needed
                videoElement.appendChild(sourceElement);
                mediaContent.appendChild(videoElement);
            });
        }
        
        var Seemore_PopUp = document.getElementById('seemore_popup');
        var overlay = document.createElement('div');
        overlay.id = 'see_more_popup_overlay';
        overlay.className = 'popup_overlay';
        document.body.appendChild(overlay); 
        overlay.addEventListener('click', function(event) {
            event.stopPropagation();
        });
        chatContainer.style.overflow = "hidden";
        Seemore_PopUp.style.display =  'block';
    }


    function SEEMOREPOPUP_Specific(multiContent, messageID, userId, type) {
        const mediaContent = document.getElementById('media_content'); 
        mediaContent.innerHTML = '';

        if (type === "IMAGE") {
            const imgElement = document.createElement('img');
            imgElement.src = `/group-media/${userId}/${messageID}/${multiContent}`;
            imgElement.style.maxWidth = '100%'; // Adjust this as needed
            imgElement.style.margin = '10px 0'; // Adjust spacing as needed
            mediaContent.appendChild(imgElement);
        } else if (type === "VIDEO") {
            const videoElement = document.createElement('video');
            const sourceElement = document.createElement('source');
            sourceElement.src = `/group-media/${userId}/${messageID}/${multiContent}`;
            sourceElement.type = 'video/mp4';
            videoElement.controls = true;
            videoElement.style.maxWidth = '100%'; // Adjust this as needed
            videoElement.style.margin = '10px 0'; // Adjust spacing as needed
            videoElement.appendChild(sourceElement);
            mediaContent.appendChild(videoElement);
        }
        
        var Seemore_PopUp = document.getElementById('seemore_popup');
        var overlay = document.createElement('div');
        overlay.id = 'see_more_popup_overlay';
        overlay.className = 'popup_overlay';
        document.body.appendChild(overlay); 
        overlay.addEventListener('click', function(event) {
            event.stopPropagation();
        });
        chatContainer.style.overflow = "hidden";
        Seemore_PopUp.style.display =  'block';
    }


    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }


    function generateUniqueId() {
        const timestamp = Math.floor(new Date().getTime() / 1000).toString(16); // Using seconds and converting to hex
        const randomPart = Math.floor(Math.random() * 1679616).toString(16); // Adjusted to generate a 3-character hex
        const uniqueId = timestamp + '0'.repeat(9 - randomPart.length) + randomPart;

        if (uniqueId.length < 24) {
            const remainingChars = 24 - uniqueId.length;
            const additionalRandom = Math.floor(Math.random() * Math.pow(16, remainingChars)).toString(16);
            return uniqueId + '0'.repeat(remainingChars - additionalRandom.length) + additionalRandom;
        }

        return uniqueId;
    }   


    function togglePostGroupChat() {
        var view_poll = document.getElementById('view_Poll');
        if(view_poll.style.display == "block"){
            view_poll.style.display = "none"
        }
        var view_votes_section = document.getElementById('view_votes_section');
        if(view_votes_section.style.display == "block"){
            view_votes_section.style.display = "none"
        }
        var initialize_poll = document.getElementById('initialize_poll');
        if(initialize_poll.style.display == "block"){
            initialize_poll.style.display = "none"
        }
        const plusOption = document.getElementById('view_Plus_option');
        plusOption.style.display = "none"
        var postGroupChatContainer = document.getElementById('post-groupchat-container');
        postGroupChatContainer.style.display = (postGroupChatContainer.style.display === 'none') ? 'block' : 'none';
        chatContainer.style.overflow = "hidden"
    }


    function viewpImage(event) {
        var input = event.target;
        videoCount = 0;

        // Clear previous previews
        document.getElementById('previewContainer').innerHTML = "";
        document.getElementById('userView').src = "";

        if (input.files.length > 30) {
            alert("You can only select up to 30 files at once.");
            input.value = "";
            return;
        }

        var carouselInner = document.createElement("div");
        carouselInner.className = "carousel-inner";

        for (var i = 0; i < input.files.length; i++) {
            var carouselItem = document.createElement("div");
            carouselItem.className = i === 0 ? "carousel-item active" : "carousel-item";

            // Set a fixed height for carousel items
            carouselItem.style.height = "300px"; // Adjust the height as needed

            if (input.files[i].type.includes("video")) {
                videoCount++;
                var videoPreview = document.createElement("video");
                videoPreview.controls = true;
                videoPreview.classList.add("video-preview_popup"); 
                var source = document.createElement("source");
                source.src = URL.createObjectURL(input.files[i]);
                source.type = input.files[i].type;

                videoPreview.appendChild(source);
                carouselItem.appendChild(videoPreview);
            } else {
                var imgPreview = document.createElement("img");
                imgPreview.classList.add("image-preview_popup"); 
                imgPreview.src = URL.createObjectURL(input.files[i]);
                carouselItem.appendChild(imgPreview);
            }

            carouselInner.appendChild(carouselItem);
        }

        document.getElementById('previewContainer').appendChild(carouselInner);
    }


    function resizeTextarea() {
        var textarea = document.getElementById("message-input-group-post"); 
        var textareaPoll = document.getElementById("caption_poll");
        textarea.style.height = "auto";
        textarea.style.height = (textarea.scrollHeight) + "px";
        textareaPoll.style.height = "auto";
        textareaPoll.style.height = (textareaPoll.scrollHeight) + "px";
    }


    function closePopup() {
        document.getElementById("post-groupchat-container").style.display = "none";
        chatContainer.style.overflow = "auto"
        const plusOption = document.getElementById('view_Plus_option');
        plusOption.style.display =  'block';
    }

    function closePopupSeeMore() {
        document.getElementById("seemore_popup").style.display = "none";
        var overlay = document.getElementById('see_more_popup_overlay')
        if (overlay) {
            overlay.remove();
        }
        chatContainer.style.overflow = "auto";
    }


    function saveScrollPosition() {
        //console.log("SAVE FUNCTION CALLED")
        sessionStorage.setItem("chatScrollPosition", chatContainer.scrollTop);
        //console.log("SAVED SCROLL POSITION : ",chatContainer.scrollTop)
    }


    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }


    // Function to restore scroll position from local storage
    function restoreScrollPosition() {
        //console.log("RESTORE FUNCTION CALLED")
        const scrollPosition = sessionStorage.getItem("chatScrollPosition");
        //console.log("RESTORED SCROLL POSITION : ",scrollPosition)
        if (scrollPosition) {
            chatContainer.scrollTop = scrollPosition;
        }
    }


    document.addEventListener("DOMContentLoaded", function() {
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const image = entry.target.querySelector('.preview');
                    if (image) {
                        //console.log("IMAGE SOURCE CALLED")
                        image.src = image.parentElement.dataset.src;
                        observer.unobserve(entry.target);
                    }
                    const video = entry.target.querySelector('video');
                    if (video) {
                        const source = video.querySelector('source');
                        //console.log("VIDEO SOURCE CALLED")
                        source.src = entry.target.dataset.src;
                        video.load();
                        observer.unobserve(entry.target);
                    }
                }
            });
        });


        // Restore scroll position when the DOM is loaded
         restoreScrollPosition();

        // Add event listener to save scroll position when scrolling
        chatContainer.addEventListener("scroll",  debounce(saveScrollPosition, 200));

        const imageItems = document.querySelectorAll('.image-item');
        imageItems.forEach(item => {
            //console.log("IMAGE CALLED")
            observer.observe(item);
        });

        const videoItems = document.querySelectorAll('.video-item');
        videoItems.forEach(item => {
            //console.log("VIDEO CALLED")
            observer.observe(item);
        });       

        const lastMessageScroll = document.getElementById("last_message_scroll");
        if (lastMessageScroll) {
            const messageId = lastMessageScroll.getAttribute('data-message-id');
            scrollToFirstMessage(messageId);
        } else if (sessionStorage.chatScrollPosition){
            chatContainer.scrollTop = sessionStorage.chatScrollPosition
        } else {
            scrollToBottom();
        }
    });



    /*function scrollToMessage(messageId) {  //  NEEDED EDIT HERE
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
            messageElement.scrollIntoView({ behavior: 'smooth' });
            messageElement.classList.add('highlight');
            setTimeout(() => {
                messageElement.classList.remove('highlight');
            }, 2000);
        }
    }*/


    async function scrollToMessage(messageId) {
        const loadingIndicatorLoader = document.getElementById('loading-indicator_loader');

        try {
            loadingIndicatorLoader.style.display = 'block'; // Show the loading indicator at the start
            chatContainer.style.overflow = "hidden";

            const messageElement = document.getElementById(messageId);

            if (!messageElement) {
                await getRemainingMessagesToScroll(messageId);  // Load more messages and search again
            } else {
                messageElement.scrollIntoView({ behavior: 'smooth' });
                messageElement.classList.add('highlight');
                setTimeout(() => {
                    messageElement.classList.remove('highlight');
                }, 2000);
            }
        } catch (error) {
            console.error('Error fetching message:', error);
        } finally {
            loadingIndicatorLoader.style.display = 'none'; // Hide the loading indicator after everything is done
            chatContainer.style.overflow = "auto";
        }
    }
    

    async function getRemainingMessagesToScroll(messageId) {
        const loadingIndicatorLoader = document.getElementById('loading-indicator_loader');
        let limit = 35;

        try {

            let response = await $.ajax({
                url: '/get_remaining_groupchatmessages',
                method: 'post',
                data: {
                    skip: sessionStorage.getItem('limiter'),
                    limit: parseInt(limit)
                }
            });

            if (response.success) {
                var new_messages = response.messages;

                if (new_messages && new_messages.length > 0) {
                    skip = parseInt(skip) + parseInt(limit); // Assuming you meant to increase by limit which is 35 here
                    sessionStorage.setItem('limiter', skip);
                    new_messages.forEach(message_s => {
                        // Prepend each post to the existing posts container
                        $("#new_mess_container").prepend(displayMultiMessageContent(message_s));
                    });

                    // Try to scroll to the message again after loading more messages
                    await scrollToMessage(messageId);
                }
            }
        } catch (error) {
            console.error('Error fetching messages:', error);
        }
    }


    function scrollToFirstMessage(messageId) {
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
            messageElement.scrollIntoView({ behavior: 'smooth' });
        }
    }


    /*var Velements = document.getElementsByClassName("video-item");
    for (var i = 0; i < Velements.length; i++) {
        Velements[i].style.display = "block";
    }


    var Ielements = document.getElementsByClassName("image-item");
    for (var i = 0; i < Ielements.length; i++) {
        Ielements[i].style.display = "block";
    }*/


    /*function sendTimestampOnUnload() {
        const timestamp = new Date().toISOString();
        const messageCount = document.querySelectorAll('.message').length;

        // Use navigator.sendBeacon for asynchronous data transmission during unload
        const url = '/send_timestamp_leave_groupchat';
        const body = JSON.stringify({ timestamp, messageCount });
        const blob = new Blob([body], { type: 'application/json' });

        navigator.sendBeacon(url, blob);
    }
    window.addEventListener('beforeunload', sendTimestampOnUnload);*/


    //   TEST BUD
    function sendTimestampOnUnload() {
        const timestamp = new Date().toISOString();

        // Use navigator.sendBeacon for asynchronous data transmission during unload
        const url = '/send_timestamp_leave_groupchat';

        navigator.sendBeacon(url);
    }
    window.addEventListener('beforeunload', sendTimestampOnUnload);


   /* window.onload = function () {
        const referrer = "{{referrer}}";
        if (referrer && referrer !== "") {
            window.history.replaceState(null, null, referrer);
        }
    };*/


    function view_mess_options(messageId, event) {
        event.stopPropagation(); // Prevents the event from bubbling up
        var dropdown = document.getElementById('dropdown-' + messageId);
        if (dropdown.style.display === "block") {
            dropdown.style.display = "none";
        } else {
            dropdown.style.display = "block";
        }
    }


    function showEmojiPopup(messageId, event) {
        event.stopPropagation(); // Prevents the event from bubbling up
        var dropdown = document.getElementById('dropdown-' + messageId);
        dropdown.style.display = "none";

        var emojiPopup = document.getElementById('emoji-popup-' + messageId);
        emojiPopup.style.display = "block";
    }


    function showEmojiwithouteventPopup(messageId) {
        var dropdown = document.getElementById('dropdown-' + messageId);
        dropdown.style.display = "none";

        var emojiPopup = document.getElementById('emoji-popup-' + messageId);
        emojiPopup.style.display = "block";
    }


    function closeEmojiPopup(messageId, event) {
        event.stopPropagation(); // Prevents the event from bubbling up
        var emojiPopup = document.getElementById('emoji-popup-' + messageId);
        emojiPopup.style.display = "none";
    }


    async function pin(messageId) {
        try {
            //console.log("PIN FUNCTION CALLED")
            await saveScrollPosition();
            pinnedMESSAGE = localStorage.getItem("PinMessageLocally");
            const response = await $.ajax({
                url: '/add_pin_groupchat',
                method: 'post',
                data: {
                    MeSsAgEiD: messageId,
                    userID: myID
                }
            });
            if (response.addedPin) {
                await socket.emit('chatMessagepin',  
                    {messageId,pinnedMESSAGE}
                );
                await localStorage.setItem("PinMessageLocally", messageId);
                pinnedMESSAGE = localStorage.getItem("PinMessageLocally");
            }
        } catch (error) {
            console.error('Error in pin function:', error);
        }
    }


    async function unpin(messageId) {
        try {
            await saveScrollPosition();
            const response = await $.ajax({
                url: '/remove_pin_groupchat',
                method: 'post',
                data: {
                    MeSsAgEiD: messageId,
                    userID: myID
                }
            });
            if (response.removedPin) {
                await socket.emit('chatMessageUnpin');
            }
        } catch (error) {
            console.error('Error in pin function:', error);
        }
    }


    function doThePin(data) {
        // Find the currently pinned message element and update its isPinned property
        let pinnedMessageElement = document.getElementById(data.pinnedMESSAGE);
        if (pinnedMessageElement) {
            // Find the pin/unpin option and change it to "Pin"
            let unpinOption = pinnedMessageElement.querySelector('li[onclick*="unpin"]');
            if (unpinOption) {
                unpinOption.innerText = 'Pin';
                unpinOption.setAttribute('onclick', `pin('${data.pinnedMESSAGE}')`);
            }
        }

        // Find the new message element to be pinned and update its isPinned property
        let newPinnedMessageElement = document.getElementById(data.messageId);
        if (newPinnedMessageElement) {
            // Find the pin option and change it to "Unpin"
            let pinOption = newPinnedMessageElement.querySelector('li[onclick*="pin"]');
            if (pinOption) {
                pinOption.innerText = 'Unpin';
                pinOption.setAttribute('onclick', `unpin('${data.messageId}')`);
            }
        }

        // Update the option_div_main for scrolling to the new pinned message
        let option_div_main = document.getElementById('option_div_main_pin_poll');
        option_div_main.setAttribute('onclick', `scrollToMessage('${data.messageId}')`);
        option_div_main.style.display = 'flex';
    }


    function doTheUnpin(){
        let option_div_main = document.getElementById('option_div_main_pin_poll')
        option_div_main.style.display = 'none';
    }


    async function selectEmoji(messageId, emojiCount, reactionsArray, emoji) {
        try {
            await saveScrollPosition();
            var emojiPopup = document.getElementById('emoji-popup-' + messageId);
            emojiPopup.style.display = "none";

            await localStorage.setItem("PinEmojiReloadStatus", 1);
            emojiPopup.style.display = "none";
            const response = await $.ajax({
                url: '/add_reaction_groupchat',
                method: 'post',
                data: {
                    MeSsAgEiD: messageId,
                    EmOjIcOnTeNt: emoji,
                }
            });
            
            if (response.addedReaction) {
                // Fetch the updated message data
                const updatedMessageResponse = await $.ajax({
                    url: '/get_message_by_id_emoji',
                    method: 'POST',
                    data: {
                        MeSsAgEiD: messageId,
                    }
                });
                if (updatedMessageResponse.message) {
                    updatedMessageResponse.message.MessageId = messageId;
                    //console.log("MESSAGE VALID : ", updatedMessageResponse.message);

                    // Update the message content in the DOM
                    //await updateMessageContentInDOM(updatedMessageResponse.message);
                
                    await socket.emit('chatMessageEmoji',  
                        updatedMessageResponse.message
                    );
                }
            }
        } catch (error) {
            console.error('Error in selectEmoji function:', error);
        }
    }


    function updateMessageContentInDOM(updatedMessage) {
        //console.log("UPDATE MESSAGE CONTENT : ",updatedMessage)
        var view_reactions_pop = document.getElementById('view_reactions_' + updatedMessage.MessageId);
        const darkEnabler = localStorage.getItem('darkModeARCCEC') === 'enabled';

        //console.log("UPDATE MESS RECEIVED")
        const messageElement = document.getElementById(updatedMessage.MessageId);
        if (messageElement) {
            // Update reactions
            let reactionDiv = messageElement.querySelector('.reaction_div');
            
            if (!reactionDiv) {
                // Create reaction div if it doesn't exist
                reactionDiv = document.createElement('div');
                reactionDiv.className = 'reaction_div'; 
                reactionDiv.setAttribute('onclick', `view_mess_reactionss('${updatedMessage.MessageId}')`);
                messageElement.appendChild(reactionDiv);
            }
            
            if (updatedMessage.reactions && updatedMessage.reactions.length > 0){
                reactionDiv.innerHTML = `<div class="reaction_thumb"><span class="count_reaction">${updatedMessage.reactions.length}</span> ${(updatedMessage.reactions[updatedMessage.reactions.length - 1]).emoji}</div>`;
            } else {
                reactionDiv.innerHTML = '';
            }

            // Handle the reaction popup
            let reactionPopup = document.getElementById('view_reactions_' + updatedMessage.MessageId);
            if (!reactionPopup) {
                // Create the reaction popup if it doesn't exist
                reactionPopup = document.createElement('div');
                reactionPopup.id = 'view_reactions_' + updatedMessage.MessageId;
                reactionPopup.classList.add('popupform_view_reactions','right_color_box');
                if(darkEnabler){ 
                    reactionPopup.style.background = 'linear-gradient(#fff, #606060)';
                }
                reactionPopup.innerHTML = `
                    <p class="reaction_hidden_time">{{this.formattedTime}}</p>                                                
                    <p class="close_pop_up_view_reactions" onclick="closePopupViewReactions('${updatedMessage.MessageId}')">&#10006;</p>
                    <div class="Reaction_body_turnedon" style="margin-top: 50px;"></div>
                `;
                messageElement.appendChild(reactionPopup);
            }

            // Update reaction popup content
            let reactionsHTML = '';
            updatedMessage.reactions.forEach(reaction => {
                reactionsHTML += `
                    <div class="reaction_divider">
                        <div class="user_circle" style="display: flex;">
                            <a style="text-decoration: none;cursor:pointer;" >
                                <img class="user_image profileImageAlternate" src="/user-images/${reaction.user_id}.jpg" alt="User Image" onerror="this.onerror=null;this.src='/user-images/user.png';" draggable="false">
                            </a>
                        </div>
                        <a style="text-decoration: none;display: flex;">
                            <p class="p_in_like_body_turnedon">${reaction.user_Name}</p>
                        </a>
                        <p class="p_emoji">${reaction.emoji}</p>
                    </div>
                `;
            });

            const experienceHeaderColor = darkEnabler ? '#414A4C' : 'black';
            reactionPopup.querySelector('.Reaction_body_turnedon').innerHTML = `
                ${reactionsHTML}
                <p class="bot_p_1 blackName" style="color: ${experienceHeaderColor};">press on the emoji once more to remove</p>
                <p class="bot_p_2 blackName" style="color: ${experienceHeaderColor};">press on other emoji to modify your reaction</p>
            `;
            // Optionally, prevent dragging and right-clicking for images within the specific messageElement. also user.png if profile image not present
            const profileImages = messageElement.querySelectorAll('.profileImageAlternate');
            profileImages.forEach(img => {
                img.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                });
                img.addEventListener('dragstart', function(e) {
                    e.preventDefault();
                });
                img.onerror = function() {
                    this.onerror = null;
                    this.src = '/user-images/user.png';
                };
            });
        }
    }


    function view_mess_reactionss(Message_ID){
        var view_reactions_pop = document.getElementById('view_reactions_' + Message_ID);
        var overlay = document.createElement('div');
        overlay.id = 'view_reactions_overlay';
        overlay.className = 'popup_overlay';
        document.body.appendChild(overlay); 
        view_reactions_pop.style.display = 'block';
        chatContainer.style.overflow = "hidden";
        overlay.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    }


    function closePopupViewReactions(Message_ID){
        var view_reactions_pop = document.getElementById('view_reactions_' + Message_ID);
        view_reactions_pop.style.display = 'none';
        chatContainer.style.overflow = "auto";
        var overlay = document.getElementById('view_reactions_overlay')
        if (overlay) {
            overlay.remove();
        }
    }

    
    let pressTimer;
    let longPressActivated = false;
    let currentDivId = null;


    function startPressTimer(divId) {
        currentDivId = divId;
        pressTimer = setTimeout(() => handleLongPress(divId), 700); // 1000ms for a 1-second long press
    }


    function handlePressRelease() {
        clearTimeout(pressTimer);
        if (!longPressActivated) {
            currentDivId = null;
        }
    }


    function handleLongPress(divId) {
        longPressActivated = true;
        //console.log(`Long press detected on div with id: ${divId}`);
        // Perform any action required for long press
        showEmojiwithouteventPopup(divId)
    }


    // Add an event listener for clicks anywhere on the document
    document.addEventListener('click', (event) => {
        if (longPressActivated && event.target.id !== currentDivId) {
            longPressActivated = false;
            currentDivId = null;
            //console.log('Long press deactivated');
            // Perform any cleanup or action required when long press is deactivated
        }
    }, true);


    // Prevent scrolling during touch to prevent unintended behavior
    /*document.addEventListener('touchmove', (event) => {
        if (longPressActivated) {
            event.preventDefault();
        }
    }, { passive: false });*/


    //  FUNCTION TO VIEW PROFILE
    function viewProfile(profileId) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/view-profile';
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'profileId';
        input.value = profileId;
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
    

    window.onload = function() {
        // Your existing variables and function definitions
        var topReached = false;
        var limit = 35; 
        var initialLoad = true; // Flag to track initial load
        var skip = parseInt(sessionStorage.getItem('limiter')) || 0;

        async function checkScroll() {
            var scrollPosition = chatContainer.scrollTop;

            if (initialLoad) {
                initialLoad = false;
                return;
            }

            if (scrollPosition <= 30 && !topReached) {
                topReached = true;

                let response = await $.ajax({
                    url: '/get_remaining_groupchatmessages',
                    method: 'post',
                    data: {
                        skip: skip,
                        limit: limit
                    }
                });

                if(response.success){ 
                    var nem_messages = response.messages;
                    if(nem_messages && nem_messages.length > 0){
                        skip += limit;
                        sessionStorage.setItem('limiter', skip);
                        $("#loadingIndicator").show();
                        nem_messages.forEach(message_s => {
                            // Prepend each post to the existing posts container
                            $("#new_mess_container").prepend(displayMultiMessageContent(message_s));
                        });
                        $("#loadingIndicator").hide();
                    }
                } else {
                    $("#loadingIndicator").hide();
                }
            } else if (scrollPosition > 30) {
                topReached = false;
            }
        }

        // Listen for scroll events on the chatContainer container
        chatContainer.addEventListener('scroll', checkScroll);
    };


    //    FUNCTION TO RENDER NEW MESSAGES ON REACHING TOP
    function displayMultiMessageContent(data) {
        
        const  darkEnabler = localStorage.getItem('darkModeARCCEC') === 'enabled';
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message');
        if (data.userId === myID) {
            messageContainer.classList.add('message_me');
        }

        if(!data.deleteStatus){
            messageContainer.id = data.MessageId;
            messageContainer.setAttribute('onmousedown', `startPressTimer('${data.MessageId}')`);
            messageContainer.setAttribute('onmouseup', 'handlePressRelease()');
            messageContainer.setAttribute('onmouseleave', 'handlePressRelease()');
            messageContainer.setAttribute('ontouchstart', `startPressTimer('${data.MessageId}')`);
            messageContainer.setAttribute('ontouchend', 'handlePressRelease()');

            const optionDiv = document.createElement('div');
            optionDiv.classList.add('option_div');
            optionDiv.setAttribute('onclick', `view_mess_options('${data.MessageId}', event)`);

            const ellipsisIcon = document.createElement('i');
            ellipsisIcon.classList.add('fa-solid', 'fa-ellipsis');
            ellipsisIcon.style.fontSize = '22px';

            const dropdown = document.createElement('div');
            dropdown.classList.add('dropdownND');
            dropdown.id = `dropdown-${data.MessageId}`;

            const ul = document.createElement('ul');
            const reactLi = document.createElement('li');
            reactLi.setAttribute('onclick', `showEmojiPopup('${data.MessageId}', event)`);
            reactLi.textContent = 'React';

            ul.appendChild(reactLi);

            if (data.userId === myID) {
                const pinLi = document.createElement('li');
                pinLi.setAttribute('onclick', `pin('${data.MessageId}')`);
                pinLi.textContent = 'Pin';

                const deleteLi = document.createElement('li');
                deleteLi.setAttribute('onclick', `deleteMessage('${data.MessageId}')`);
                deleteLi.textContent = 'Delete';

                ul.appendChild(pinLi);
                ul.appendChild(deleteLi);
            }

            dropdown.appendChild(ul);
            optionDiv.appendChild(ellipsisIcon);
            optionDiv.appendChild(dropdown);
            messageContainer.appendChild(optionDiv);

            const emojiPopup = document.createElement('div');
            emojiPopup.classList.add('emoji-popup','right_color_box');
            if(darkEnabler){
                emojiPopup.style.background = 'linear-gradient(#fff, #606060)';
            }
            emojiPopup.id = `emoji-popup-${data.MessageId}`;

            const emojis = ['üòÄ', 'üòÇ', 'üòç', 'üëç', '‚ù§Ô∏è', 'üò¢'];
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.setAttribute('onclick', `selectEmoji('${data.MessageId}', null, null, '${emoji}')`);
                span.textContent = emoji;
                emojiPopup.appendChild(span);
            });

            const closeBtn = document.createElement('span');
            closeBtn.classList.add('close-btn');
            closeBtn.setAttribute('onclick', `closeEmojiPopup('${data.MessageId}', event)`);
            closeBtn.textContent = '‚úñ';
            emojiPopup.appendChild(closeBtn);

            messageContainer.appendChild(emojiPopup);
        }

        const userCircle = document.createElement('div');
        userCircle.classList.add('user-circle');

        const userImageLink = document.createElement('a');
        userImageLink.style.textDecoration = 'none';
        if (data.SENDBY === 'USER') {
            userImageLink.setAttribute('onclick', `viewProfile('${data.userId}')`);
        }

        const userImage = document.createElement('img');
        userImage.classList.add('user-image');
        userImage.src = `/user-images/${data.userId}.jpg`;
        userImage.alt = 'User Image';

        userImage.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // Prevent dragging
        userImage.addEventListener('dragstart', function(e) {
            e.preventDefault();
        });

        // Profile image fallback handling
        fetch(userImage.src)
            .then(response => {
                if (!response.ok) {
                    userImage.src = '/user-images/user.png';
                }
            })
            .catch(error => {
                console.error('Error fetching image:', error);
                userImage.src = '/user-images/user.png';
            });

        userImageLink.appendChild(userImage);
        userCircle.appendChild(userImageLink);

        const messageContentContainer = document.createElement('div');
        messageContentContainer.style.display = 'flex';
        messageContentContainer.style.flexDirection = 'column';
        messageContentContainer.style.width = '100%';

        // Reply handling (commented out in original code)
        /*
        if (data.message.actualMessageId && data.message.actualMessageId !== "" && data.message.actualMessageContent !== "") {
            const replyDiv = document.createElement('div');
            replyDiv.classList.add('reply');
            replyDiv.style.marginBottom = '-20px';
            replyDiv.textContent = `replied to: ${data.message.actualMessageContent}`;
            replyDiv.setAttribute('onclick', `scrollToMessage('${data.message.actualMessageId}')`);
            messageContentContainer.appendChild(replyDiv);
        }
        */

        if (data.actualMessageId != "" && data.actualMessageContent) {
            /*const replyDiv = document.createElement('div');
            replyDiv.classList.add('reply');
            replyDiv.style.marginBottom = '-20px';
            replyDiv.textContent = `replied to: ${data.actualMessageContent}`;
            replyDiv.setAttribute('onclick', `scrollToMessage('${data.actualMessageId}')`);
            messageContentContainer.appendChild(replyDiv);*/


            // Create the div container for the reply
            const replyDiv = document.createElement('div');
            replyDiv.classList.add('reply','darkcolorchanger3');
            replyDiv.style.marginBottom = '-25px';
            if(darkEnabler){
                replyDiv.style.backgroundColor = 'black';
                replyDiv.style.color = 'white';
            }
            replyDiv.setAttribute('onclick', `scrollToMessage('${data.actualMessageId}')`);

            // Create the 'repliedTO' span element
            const repliedToSpan = document.createElement('span');
            repliedToSpan.classList.add('repliedTO');
            repliedToSpan.textContent = 'replied to : ';

            // Create the 'replytext' p element
            const replyTextP = document.createElement('p');
            replyTextP.classList.add('replytext');
            replyTextP.textContent = data.actualMessageContent; // Set the actual message content

            // Append the 'repliedTO' span and 'replytext' p elements to the replyDiv
            replyDiv.appendChild(repliedToSpan);
            replyDiv.appendChild(replyTextP);

            // Append the entire replyDiv to the message content container
            messageContentContainer.appendChild(replyDiv);
        }

        const userNameLink = document.createElement('a');
        userNameLink.style.textDecoration = 'none';
        userNameLink.style.color = 'black';
        if (data.SENDBY === 'USER') {
            userNameLink.setAttribute('onclick', `viewProfile('${data.userId}')`);
        }

        const userName = document.createElement('div');
        userName.classList.add('user-name');
        userName.textContent = data.Name;

        userNameLink.appendChild(userName);
        messageContentContainer.appendChild(userNameLink);

        const actualMessage = document.createElement('div');
        actualMessage.classList.add('actual-message');
        actualMessage.id = `message_content_${data.MessageId}`;  // Add ID to match the updated structure

        // Create the inner message content div
        const messageContentDiv = document.createElement('div');
        messageContentDiv.classList.add('message_content_class');
        messageContentDiv.id = `Message_Content_ID_${data.MessageId}`;
        messageContentDiv.innerHTML = data.messageContent;  // Set the message content

        actualMessage.appendChild(messageContentDiv);  // Append message content to the actual message div

        // Create the "Show More" link
        const showMoreLink = document.createElement('a');
        showMoreLink.href = 'javascript:void(0)';
        showMoreLink.classList.add('show_more');
        showMoreLink.id = `show_more_${data.MessageId}`;
        showMoreLink.textContent = 'Show More';
        showMoreLink.onclick = function() { toggleMessageContent(data.MessageId); };

        actualMessage.appendChild(showMoreLink);  // Append the "Show More" link to the actual message div

        // Handling delete status
        if (data.deleteStatus && data.deleteStatus === "deletedMessage") {
            actualMessage.style.color = "red";
            actualMessage.style.fontStyle = "italic";  // Match the deleted message style

            // Create deleted timestamp paragraph
            const deletetimestampPara = document.createElement('p');
            deletetimestampPara.classList.add('delete_time');
            deletetimestampPara.textContent = data.formattedDeletedTime;
            messageContentContainer.appendChild(deletetimestampPara);

            // Create timestamp paragraph for normal time
            const timestampPara = document.createElement('p');
            timestampPara.classList.add('post_time');
            timestampPara.textContent = data.formattedTime;
            messageContentContainer.appendChild(timestampPara);

        } else if (!data.deleteStatus) {
            // For non-deleted messages, add the timestamp
            const timestampPara = document.createElement('p');
            timestampPara.classList.add('no_delete_time');
            timestampPara.textContent = data.formattedTime;
            messageContentContainer.appendChild(timestampPara);
        }

        // Finally, append the entire actualMessage to its container
        messageContentContainer.appendChild(actualMessage);

        // Adding multimedia content
        if (data.status === 'multimedia') {
            const gridContainer = document.createElement('div');
            gridContainer.classList.add('grid-container', 'extra-items');
            gridContainer.style.marginBottom = '-30px';

            if (data.ImageNames && data.ImageNames.length > 0) {
                data.ImageNames.forEach(image => {
                    const imageItem = document.createElement('div');
                    imageItem.classList.add('grid-item', 'image-item');
                    imageItem.dataset.src = `/group-media/${data.userId}/${data.MessageId}/${image}`;
                    imageItem.setAttribute('onclick', `SEEMOREPOPUP_Specific('${image}', '${data.MessageId}', '${data.userId}', 'IMAGE')`);

                    const img = document.createElement('img');
                    img.classList.add('preview');
                    img.src = `/group-media/${data.userId}/${data.MessageId}/${image}`;
                    img.alt = 'Image';

                    imageItem.appendChild(img);
                    gridContainer.appendChild(imageItem);
                });
            }

            if (data.VideoNames && data.VideoNames.length > 0) {
                data.VideoNames.forEach(video => {
                    const videoItem = document.createElement('div');
                    videoItem.classList.add('grid-item', 'video-item');
                    videoItem.dataset.src = `/group-media/${data.userId}/${data.MessageId}/${video}`;
                    videoItem.setAttribute('onclick', `SEEMOREPOPUP_Specific('${video}', '${data.MessageId}', '${data.userId}', 'VIDEO')`);

                    const videoElement = document.createElement('video');
                    videoElement.classList.add('preview');
                    videoElement.controls = true;

                    const source = document.createElement('source');
                    source.src = `/group-media/${data.userId}/${data.MessageId}/${video}`;
                    source.type = 'video/mp4';

                    videoElement.appendChild(source);
                    videoItem.appendChild(videoElement);
                    gridContainer.appendChild(videoItem);
                });
            }

            if (data.ImageNames && data.VideoNames && (data.ImageNames.length + data.VideoNames.length > 3)) {
                const seeMoreItem = document.createElement('div');
                seeMoreItem.classList.add('grid-item', 'see-more-item', 'hidden');

                const seeMoreOverlay = document.createElement('div');
                seeMoreOverlay.classList.add('see-more-overlay');

                const seeMoreButton = document.createElement('button');
                seeMoreButton.classList.add('see-more-button');
                seeMoreButton.setAttribute('onclick', `SEEMOREPOPUP('${data.ImageNames}', '${data.VideoNames}', '${data.MessageId}', '${data.userId}')`);
                seeMoreButton.textContent = 'See more';

                seeMoreOverlay.appendChild(seeMoreButton);
                seeMoreItem.appendChild(seeMoreOverlay);
                gridContainer.appendChild(seeMoreItem);
            }

            messageContentContainer.appendChild(gridContainer);
        }

        if(!data.deleteStatus){
            const replyDelDiv = document.createElement('div');
            replyDelDiv.classList.add('reply_del_div');

            const replyButton = document.createElement('button');
            replyButton.classList.add('reply_link');
            if (!data.deleteStatus || data.deleteStatus !== 'deletedMessage') {
                replyButton.setAttribute('onclick', `replyToMessage('${data.MessageId}', '${data.messageContent}', '${data.Name}')`);
            }
            replyButton.innerHTML = '<i class="fa-solid fa-reply" style="padding: 0px;"></i>';
            replyDelDiv.appendChild(replyButton);
            messageContentContainer.appendChild(replyDelDiv);

            if (data.reactions && data.reactions.length > 0) {
                const reactionDiv = document.createElement('div');
                reactionDiv.classList.add('reaction_div');
                reactionDiv.setAttribute('onclick', `view_mess_reactionss('${data.MessageId}')`);

                const reactionThumb = document.createElement('div');
                reactionThumb.classList.add('reaction_thumb');
                reactionThumb.innerHTML = `<span class="count_reaction">${data.reactions.length}</span> ${getLastReaction(data.reactions)}`;
                reactionDiv.appendChild(reactionThumb);
                messageContainer.appendChild(reactionDiv);

                const viewReactionsPopup = document.createElement('div');
                viewReactionsPopup.id = `view_reactions_${data.MessageId}`;
                viewReactionsPopup.classList.add('popupform_view_reactions');
                if(darkEnabler){
                    viewReactionsPopup.style.background = 'linear-gradient(#fff, #606060)';
                    viewReactionsPopup.classList.add('right_color_box');
                }

                const reactionTime = document.createElement('p');
                reactionTime.classList.add('reaction_hidden_time');
                reactionTime.textContent = data.formattedTime;
                viewReactionsPopup.appendChild(reactionTime);

                const closeBtn = document.createElement('p');
                closeBtn.classList.add('close_pop_up_view_reactions');
                closeBtn.innerHTML = '&#10006;';
                closeBtn.onclick = function() {
                    closePopupViewReactions(data.MessageId);
                };
                viewReactionsPopup.appendChild(closeBtn);

                const reactionBody = document.createElement('div');
                reactionBody.classList.add('Reaction_body_turnedon');
                reactionBody.style.marginTop = '50px';

                data.reactions.forEach(reaction => {
                    const reactionDivider = document.createElement('div');
                    reactionDivider.classList.add('reaction_divider');

                    const userCircle = document.createElement('div');
                    userCircle.classList.add('user_circle');
                    userCircle.style.display = 'flex';
                    userCircle.innerHTML = `<a style="text-decoration: none;cursor:pointer;" href="javascript:void(0)" onclick="viewProfile('${reaction.user_id}')">
                                                <img class="user_image profileImageAlternate" src="/user-images/${reaction.user_id}.jpg" alt="User Image" draggable="false">
                                            </a>`;
                    reactionDivider.appendChild(userCircle);

                    const userNameLink = document.createElement('a');
                    userNameLink.style.textDecoration = 'none';
                    userNameLink.style.display = 'flex';
                    userNameLink.href = 'javascript:void(0)';
                    userNameLink.setAttribute('onclick', `viewProfile('${reaction.user_id}')`);
                    userNameLink.innerHTML = `<p class="p_in_like_body_turnedon">${reaction.user_Name}</p>`;
                    reactionDivider.appendChild(userNameLink);

                    const emojiText = document.createElement('p');
                    emojiText.classList.add('p_emoji');
                    emojiText.textContent = reaction.emoji;
                    reactionDivider.appendChild(emojiText);

                    reactionBody.appendChild(reactionDivider);
                });

                const botP1 = document.createElement('p');
                botP1.classList.add('bot_p_1','blackName');
                if(darkEnabler){
                    botP1.style.color = '#414A4C';
                }
                botP1.textContent = 'Press on the emoji once more to remove';
                reactionBody.appendChild(botP1);

                const botP2 = document.createElement('p');
                botP2.classList.add('bot_p_2','blackName');
                if(darkEnabler){
                    botP2.style.color = '#414A4C';
                }
                botP2.textContent = 'Press on other emoji to modify your reaction';
                reactionBody.appendChild(botP2);

                viewReactionsPopup.appendChild(reactionBody);

                const profileImages = viewReactionsPopup.querySelectorAll('.profileImageAlternate');
                profileImages.forEach(img => {
                    img.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                    });
                    img.addEventListener('dragstart', function(e) {
                        e.preventDefault();
                    });
                    img.onerror = function() {
                        this.onerror = null;
                        this.src = '/user-images/user.png';
                    };
                });

                document.body.appendChild(viewReactionsPopup);
            }
        }

        messageContentContainer.appendChild(actualMessage);
        messageContainer.appendChild(userCircle);
        messageContainer.appendChild(messageContentContainer);

        // Append to the correct container
        const newMessContainer = document.getElementById('new_mess_container');
        newMessContainer.prepend(messageContainer);
        checkContentOverflow(data.MessageId);
    }


    function getLastReaction(reactions) {
        if (reactions && reactions.length > 0) {
            return reactions[reactions.length - 1].emoji;
        }
        return '';
    }


    function closePopupViewPoll() {
        document.getElementById("view_Poll").style.display = "none";
        var overlay = document.getElementById('show_poll_overlay');
        if (overlay) {
            overlay.remove();
        }
        chatContainer.style.overflow = "auto";
    }


    function showPoll(){
        var postGroupChatContainer = document.getElementById('post-groupchat-container');
        if(postGroupChatContainer.style.display == "block"){
            postGroupChatContainer.style.display = "none"
        }
        const poll = document.getElementById('view_Poll')

        var overlay = document.createElement('div');
        overlay.id = 'show_poll_overlay';
        overlay.className = 'popup_overlay';
        document.body.appendChild(overlay); 

        poll.style.display = "block"
        chatContainer.style.overflow = "hidden";

        overlay.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    } 


    function submitPoll(value,pollID){
        try {

            let response =  $.ajax({
                url: '/submit_group_poll',
                method: 'post',
                data: {
                    vAlUe : value,
                    pOlLiD : pollID
                }
            });

            if (response.success) {
                var overlay = document.getElementById('show_poll_overlay');
                 if (overlay) {
                    overlay.remove();
                }
                chatContainer.style.overflow = "auto";
            }

        } catch (error) {
            console.error('Error submitting poll:', error);
        }
    }


    function plus_button_options() {
        const plusOption = document.getElementById('view_Plus_option');
        var overlay = document.createElement('div');
        overlay.id = 'plus_button_option_overlay';
        overlay.className = 'popup_overlay';
        plusOption.style.display = 'block';
        chatContainer.style.overflow = 'hidden';
        document.body.appendChild(overlay); 
        overlay.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    }

    
    function closePlusButtonOption() {
        const plusOption = document.getElementById('view_Plus_option');
        plusOption.style.display =  'none';
        var overlay = document.getElementById('plus_button_option_overlay');
        if (overlay) {
            overlay.remove();
        }
        chatContainer.style.overflow = 'auto';
    }


    function initialize_poll(){
        var postGroupChatContainer = document.getElementById('post-groupchat-container');
        if(postGroupChatContainer.style.display == "block"){
            postGroupChatContainer.style.display = "none"
        }
        const plusOption = document.getElementById('view_Plus_option');
        plusOption.style.display =  'none';

        const initPollBody = document.getElementById('initialize_poll')
        initPollBody.style.display = "block"
    } 

    
    function closePollDiv() {
        const pollInitial = document.getElementById('initialize_poll');
        const plusOption = document.getElementById('view_Plus_option');
        pollInitial.style.display =  'none';
        plusOption.style.display =  'block';
    }


    function enforceCharacterLimit(textarea, maxChars) {
        if (textarea.value.length > maxChars) {
            // Limit the number of characters to the maxChars
            textarea.value = textarea.value.substring(0, maxChars);
            alert(`You can only enter a maximum of ${maxChars} characters.`);
        }
    } 


    let optionCount = 0;
    const maxOptions = 5;

    function addPollOption() {
        if (optionCount < maxOptions) {
            optionCount++;
            const optionsContainer = document.getElementById('optionsContainer');
            const newOption = document.createElement('div');
            newOption.className = 'poll-option';
            newOption.style.marginTop = '10px';

            // Create the input element
            const inputElement = document.createElement('input');
            inputElement.className = 'option_poll';
            inputElement.type = 'text';
            inputElement.name = `option${optionCount}`;
            inputElement.placeholder = `Option ${optionCount}`;
            inputElement.required = true;
            inputElement.style.marginLeft = '5px';

            // Add the oninput event to enforce the character limit
            inputElement.setAttribute('oninput', `enforceCharacterLimitPollOption(this, 20)`);

            // Append the input element to the newOption div
            newOption.appendChild(inputElement);

            // Append the new option div to the optionsContainer
            optionsContainer.appendChild(newOption);
        } else {
            alert('You can only add up to 5 options.');
        }
    }


    function enforceCharacterLimitPollOption(input, maxChars) {
        if (input.value.length > maxChars) {
            // Limit the number of characters to the maxChars
            input.value = input.value.substring(0, maxChars);
            alert(`You can only enter a maximum of ${maxChars} characters.`);
        }
    }


    async function InitializeMyPoll(event) {
        event.preventDefault();
        if (confirm("Email notification will be sended to all, so do not attempt for unwanted polls. Unwanted attempts will result in actions against you.")) {

            const poll_form = document.getElementById('initialize_poll');
            poll_form.style.display = "none";
            var overlay = document.getElementById('plus_button_option_overlay');
            if (overlay) {
                overlay.remove();
            }
            chatContainer.style.overflow = 'auto';

            const form = document.getElementById('pollForm');
            const formData = new FormData();

            // Append the content of the textarea
            const caption = document.getElementById('caption_poll').value;
            formData.append('caption', caption);
            formData.append('Poll_Id',generateUniqueId())

            // Append all the poll options
            const options = document.querySelectorAll('.option_poll');
            options.forEach((option, index) => {
                formData.append(`option${index + 1}`, option.value);
            });

            const url = '/add_poll_togroup';
            const method = 'POST';

            try { 
                const response = await $.ajax({
                    url: url,
                    method: method,
                    data: formData,
                    processData: false,
                    contentType: false,
                }); 
            } catch (error) {
                console.error('Error uploading poll:', error);
            } finally {            
                // Reset the form to its initial state
                form.reset();
                optionCount = 0; // Reset the option count
                document.getElementById('optionsContainer').innerHTML = ''; // Clear the options
                var overlay = document.getElementById('plus_button_option_overlay');
                if (overlay) {
                    overlay.remove();
                }
                chatContainer.style.overflow = 'auto';
            }
        }
    }


    function closePinBar(event) {
        event.stopPropagation(); // Prevents scrollToMessage from being called
        document.getElementById('option_div_main_pin_poll').style.display = 'none';
    }


    function closePollBar(event) {
        event.stopPropagation(); // Prevents showPoll from being called
        document.getElementById('option_div_main_pin_poll_poll').style.display = 'none';
    }


    async function viewVotes() {
        try {
            document.getElementById("view_Poll").style.display = "none";
            document.getElementById("view_votes_section").style.display = "block";
            var postGroupChatContainer = document.getElementById('post-groupchat-container');
            if(postGroupChatContainer.style.display == "block"){
                postGroupChatContainer.style.display = "none"
            }

            let response = await $.ajax({
                url: '/get_all_pollresult',
                method: 'post',
            });

            if (response.success) {
                const viewVotesSection = document.getElementById("view_votes_section");
                const reactionBody = viewVotesSection.querySelector(".Reaction_body_turnedon");

                // Clear the existing content
                reactionBody.innerHTML = '';

                // Iterate over the response and generate the HTML structure
                response.response.forEach(optionData => {
                    // Create a container for the option title and count
                    const optionContainer = document.createElement('div');
                    optionContainer.style.display = 'flex';
                    optionContainer.style.justifyContent = 'space-between';
                    optionContainer.style.alignItems = 'center';
                    optionContainer.style.marginBottom = '10px';
                    optionContainer.style.fontWeight = 'bold';

                    // Create the option title
                    const optionTitle = document.createElement('div');
                    optionTitle.textContent = optionData.option;
                    optionTitle.style.marginTop = "10px";

                    // Create the total count for the poll option
                    const optionCount = document.createElement('div');
                    optionCount.textContent = `Total: ${optionData.users.length}`;
                    optionCount.style.fontSize = '14px';
                    optionCount.style.color = '#888';


                    optionContainer.appendChild(optionTitle);
                    optionContainer.appendChild(optionCount);

                    const userList = document.createElement('ul');
                    userList.style.listStyleType = 'none';
                    userList.style.cursor = 'pointer';
                    userList.style.paddingLeft = '0';

                    optionData.users.forEach(user => {
                        const userItem = document.createElement('li');
                        userItem.style.display = 'flex';
                        userItem.style.alignItems = 'center';
                        userItem.style.marginBottom = '5px';

                        const userCircle = document.createElement('div');
                        userCircle.classList.add('user-circle_for_poll');
                        userCircle.style.marginRight = '10px'; // Space between image and name

                        const userImageLink = document.createElement('a');
                        userImageLink.style.textDecoration = 'none';
                        userImageLink.setAttribute('onclick', `viewProfile('${user.userid}')`);

                        const userImage = document.createElement('img');
                        userImage.classList.add('user-image');
                        userImage.src = `/user-images/${user.userid}.jpg`;
                        userImage.alt = 'User Image';

                        userImage.addEventListener('contextmenu', function(e) {
                            e.preventDefault();
                        });

                        // Prevent dragging
                        userImage.addEventListener('dragstart', function(e) {
                            e.preventDefault();
                        });

                        // Profile image fallback handling
                        fetch(userImage.src)
                            .then(response => {
                                if (!response.ok) {
                                    userImage.src = "/user-images/user.png";
                                }
                            })
                            .catch(error => {
                                console.error("Error fetching image:", error);
                                userImage.src = "/user-images/user.png";
                            });

                        userImage.style.width = '30px'; // Adjust the size as needed
                        userImage.style.height = '30px'; // Adjust the size as needed
                        userImage.style.borderRadius = '50%'; // Circular image

                        userImageLink.appendChild(userImage);
                        userCircle.appendChild(userImageLink);

                        const userName = document.createElement('span');
                        userName.textContent = user.name;
                        userName.style.fontSize = '15px';

                        userItem.appendChild(userCircle); // Add image circle first
                        userItem.appendChild(userName); // Add name next

                        userList.appendChild(userItem);
                    });

                    reactionBody.appendChild(optionContainer);
                    reactionBody.appendChild(userList);
                });
            }

        } catch (error) {
            console.error('Error viewing votes :', error);
        }
    }


    function closeViewVotes() {
        const pollInitial = document.getElementById('view_votes_section');
        pollInitial.style.display =  'none';
        const poll = document.getElementById('view_Poll')
        poll.style.display = "block"
    }


    function deletePoll(event,userID){
        event.stopPropagation();
        if (confirm("Do you want to delete this poll for everyone?")) {
            $.ajax({
            url: '/delete_poll',
            method: 'post',
            data: {
                UsErId: userID,
            },
            success: function (response) {
                if (response) {
                    socket.emit('deletePoll');
                }
            },
            });
        }
    }


    function limitCharacters(textarea, maxChars) {
        if (textarea.value.length > maxChars) {
            alert("You have reached the maximum allowed characters.");
            textarea.value = textarea.value.substring(0, maxChars);
        }
    }


    function toggleMessageContent(messageId) {
        const content = document.getElementById(`Message_Content_ID_${messageId}`);
        const showMoreLink = document.getElementById(`show_more_${messageId}`);

        // Check if the content is currently expanded or not
        if (content.classList.contains('expanded')) {
            // Collapse the content
            content.classList.remove('expanded');
            content.style.maxHeight = 'calc(1.5em * 6)'; // Limit to 6 lines
            showMoreLink.innerText = 'Show More';
        } else {
            // Expand the content
            content.classList.add('expanded');
            content.style.maxHeight = content.scrollHeight + 'px'; // Expand to fit the entire content
            showMoreLink.innerText = 'Show Less';
        }
    }


    // Function to check if the content exceeds 6 lines and enable the "Show More" link
    function checkContentOverflow(messageId) {
        const content = document.getElementById(`Message_Content_ID_${messageId}`);
        const showMoreLink = document.getElementById(`show_more_${messageId}`);
        
        // If the content's scrollHeight exceeds the set max-height (i.e. 6 lines), show the "Show More" link
        if (content.scrollHeight > content.clientHeight) {
            showMoreLink.classList.add('active');
        }
    }


    // After the page loads, check each mentor's content to see if it exceeds 6 lines
    document.querySelectorAll('.actual-message').forEach((mentorElement) => {
        const messageId = mentorElement.id.replace('message_content_', '');
        checkContentOverflow(messageId);
    });


</script>
