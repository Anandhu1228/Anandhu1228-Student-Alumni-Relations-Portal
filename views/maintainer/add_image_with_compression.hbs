<!-- 
Website developed by Anandhu Mohan for the Alumni Relations Cell of a college. 
Features include:
  - Job portal, Internship portal, Mentorship portal
  - Search functionality for users, students, and alumni
  - Group chat and private individual chat systems
  - Notification system and user profiles for each member
  - Admin panel to control the entire site, handle issues, and manage inquiries
  - Superadmin overseeing the activities of admins and users
  - Maintainer responsible for the main page content and styling, visible to users and external visitors
  - Advanced machine learning features that sort jobs and internships based on user profile preferences
  - Periodic email notifications and security enhancements
-->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>

    .button_plus {
        font-size: 20px;
        font-weight: bolder;
        color: rgb(153, 155, 158);
        width: 45px;
        height: 45px;
        background: #fff;
        cursor: pointer;
        border: 2px solid rgb(153, 155, 158);
        padding: 3px;
    }

    .button_plus:hover {
        background-color: rgb(153, 155, 158);
        transition: 0.2s;
        color: white;
    }

    .plus_style_button{
        padding-top:120px;
        margin-left: 20px;
    }

    .popup-form {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 5px;
        z-index: 101;
        min-width: 40%;
        width: 60%;
        height: auto;
    }

    #uploadForm {
        background-color: rgb(245, 246, 247);
        border-radius: 10px 10px 10px 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        padding: 20px;
        background-image: url('/images/logo_transparent1.png');
        background-size: 135% auto;
        background-position: center bottom 45%;
        background-repeat: no-repeat;
        z-index: 101;
    }

    .close_pop_up{
        font-size: 20px;
        position: absolute;
        top: 5px;
        right: 10px;
    }

    .close_pop_up:hover{
        color: red;
    }

    .formpostgroup {
        display: flex;
        flex-direction: column;
        margin-top: 0px;
    }

    .labelpostgroup {
        margin-top: 10px;
        font-weight: bold;
    }

    .textareapostgroup,
    .inputpostgroup {
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ffffff;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    .custom_text_area_postgroup{
        margin-bottom: 30px;
        margin-top:30px;
        max-height: 250px;
    }

    .inputpostgroup{
        border-radius: 20px;
        width: 100%;
        padding: 15px;
        font-weight: bold;
        border: none;
        box-shadow: 0 0px 4px rgba(0, 0, 0, 0.4);
        transition: box-shadow 0.3s ease;
    }

    .buttonpostgroup {
        color: #fff;
        padding: 10px;
        border: none;
        color: black;
        font-weight: bold;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 0px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .buttonpostgroup:hover {
        background-color: #d5dade;
    }

    .custom-file-upload {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
        display: inline-block;
        padding: 10px;
        cursor: pointer;
        background-color: white;
        margin-top: 0px;
        border-radius: 15px;
    }


    #imageCarousel {
        text-align: center;
        margin: auto;
    }

    .carousel-inner{
        max-height: 250px;
        width: 100%;
    }

    .video-preview_popup{
        width: 100%;
        height: 88%;
    }

    .image-preview_popup{
        width: 100%;
        max-height: 250px;
    }

    @media (max-width: 1550px) {
        .popup-form {
            min-width: 50%;
        }
    }

    @media (max-width: 1250px) {
        .popup-form {
            min-width: 54%;
        }
    }

    @media (max-width: 1050px) {
        .popup-form {
            min-width: 58%;
        }
    }

    @media (max-width: 850px) {
        .popup-form {
            min-width: 62%;
        }
    }

    @media (max-width: 650px) {
        .popup-form {
            min-width: 90%;
        }
        #uploadForm {
            padding: 30px;
        }
    }

    @media (max-width: 391px) {
        .inputpostgroup{
            font-size: 14px;
        }
    }
    
    @media (max-width: 363px) {
        .inputpostgroup{
            font-size: 12px;
        }
    }

    @media (max-height: 960px) {
       .custom_text_area_postgroup{
            font-size: 15px;
            max-height: 310px;
        }
    }

    @media (max-height: 931px) {
       .custom_text_area_postgroup{
            max-height: 240px;
            font-size: 14.5px;
        }
    } 

    @media (max-height: 828px) {
       .custom_text_area_postgroup{
            max-height: 220px;
            font-size: 14px;
        }
    }

    @media (max-height: 800px) {
       .custom_text_area_postgroup{
            max-height: 170px;
            font-size: 14px;
        }
    }

    @media (max-height: 942px) and (max-width: 942px) {
       .carousel-inner{
            max-height: 200px;
            width: 100%;
        }
        .video-preview_popup{
            width: 100%;
            max-height: 200px;
        }
        .image-preview_popup{
            width: 100%;
            max-height: 200px;
        }
    }

    @media (max-height: 744px) and (max-width: 744px) {
        .carousel-inner{
            max-height: 170px;
            width: 100%;
        }
        .video-preview_popup{
            width: 100%;
            max-height: 170px;
        }
        .image-preview_popup{
            width: 100%;
            max-height: 170px;
        }
    }

    @media (max-height: 480px) and (max-width: 480px) {
       .carousel-inner{
            max-height: 140px;
            width: 100%;
        }
        .video-preview_popup{
            width: 100%;
            max-height: 140px;
        }
        .image-preview_popup{
            width: 100%;
            max-height: 140px;
        }
    }

    @media (max-height: 458px) and  (max-width: 458px) {
       .carousel-inner{
            max-height: 130px;
            width: 100%;
        }
        .video-preview_popup{
            width: 100%;
            max-height: 100%;
        }
        .image-preview_popup{
            width: 100%;
            max-height: 100%;
        }
    }

    .container {
        padding: 3%;
        max-width: 1000px;
        margin: 0 auto;
        height: auto;
    }

    .post-container {
        position: relative;
        height: auto;
        background-color: rgb(255, 255, 255,0.8);
        box-shadow: 0 0px 4px rgba(0, 0, 0, 0.6);
    }

    .post_middle{
        margin-top: 20px;
        margin-bottom: 0px;
    }

    .post_tail{
        margin-top: 0px;
    }

    .post_image{
        height:450px;
        object-fit:contain;
        margin-bottom:10px;
    }

    .post_video{
        object-fit: contain;
        width: 100%;
        height:450px;
    }

    .caption-post{
        margin-left: 12px;
        position: relative;
        padding-bottom: 0px;
    }

    .caption-text{
        font-size: 15px;
        font-weight: 600;
        overflow: hidden;
        word-wrap: break-word;
        white-space: nowrap;
        margin-bottom: 0px;
    }

    .read-more {
        position: absolute;
        bottom: 0;
        right: 0;
        background-color: white;
        border-radius: 10px;
        padding: 5px;
        margin-bottom: 0px;
        font-weight: 600;
        cursor: pointer;
        color: rgb(177, 169, 169);
        text-decoration: none;
    }

    .button-container {
        display: flex;
        justify-content: space-between;
        width: 100%;
        margin-bottom: 0px;
        margin-top: 0px;
    }

    .edit_button{
        color: rgb(181, 140, 8);
        font-weight: 500;
        padding: 5px;
        padding-left: 15px;
        padding-right: 15px;
        margin-left: 15px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .delete_button{
        color: rgb(209, 29, 16);
        font-weight: 500;
        padding: 5px;
        margin-right: 15px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .edit_button:hover{
        color: rgb(234, 182, 11);
    }

    .delete_button:hover{
        color: rgb(252, 24, 7);
    }

     @media (max-width: 878px) {
        .post_image{
            height:450px;
        }
        .post_video{
            height:450px;
        }
    }

     @media (max-width: 778px) {
        .post_image{
            height:350px;
        }
        .post_video{
            height:350px;
        }
    }

     @media (max-width: 448px) {
        .post_image{
            height:300px;
        }
        .image-container-post{
            height:300px;
        }
        .post_video{
            height:300px;
        }
        .caption-text{
            font-size: 14px;
        }
    }

    @media (max-width: 530px) {
        .read-more{
            font-size: 10px;
            color: #7b7b7b;
        }
    }

    #uploadForm_edit {
        background-color: #e8eced;
        border-radius: 10px 10px 10px 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        padding: 15px;

    }

    .h3_edit_post {
        color: #333;
        text-align: center;
        font-weight: 500;
        margin-bottom: 20px;
    }

    .form_edit_post {
        display: flex;
        flex-direction: column;
    }

    .label_edit_post {
        margin-top: 10px;
        font-weight: bold;
    }

    .textarea_edit_post,
    .input_edit_post {
        padding: 10px;
        margin-top: 5px;
        max-height: 500px;
        border: 1px solid #ccc;
        border-radius: 7px;
    }

    .button_edit_post {
        background-color: #ffffff;
        color: #000000;
        padding: 10px;
        border: none;
        border-radius: 7px;
        cursor: pointer;
        font-size: 16px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        margin-top: 15px;
        font-weight: 500;
        margin-top: 0px;
    }

    .button_edit_post:hover {
        background-color: #e8ebed;
    }

    .popup_form_edit {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background-color: none;
        z-index: 103;
        width: 70%;
    }

    .popup_form_edit .close {
        color: #000000;
        float: right;
        font-size: 38px;
        font-weight: bold;
        cursor: pointer;
    }

    .popup_form_edit .close:hover {
        color: red; /* Change the color on hover as desired */
    }

    @media (max-width:1550px) {
        .popup_form_edit {
            width: 90%;
        }
    }

    @media (max-width:630px) {
        .popup_form_edit {
            width: 96%;
        }
    }

    #loading-indicator{
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        z-index: 1000;
    }

    #loading-indicator p{
        margin: 10px 0;
        font-size: 18px;
        font-weight: bold;
    }

    #loading-indicator .spinner{
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

</style>

<div class="plus_style_button">
    <a onclick="showAddImageGalleryMaintainer()" ><button style="border-radius:10px;" class="button_plus ">+</button></a>
</div>

<section style="margin-top: 50px; margin-bottom:20px;">
    {{#each contents}}
        <div class="container" id="post_container_{{this.MediaId}}">
            <div class="post-container">
                <div class="post_middle">
                    <div class="image-container-post">
                        <div id="carouselExampleIndicators-{{this.MediaId}}" class="carousel slide" data-ride="carousel">
                            <div>
                                {{#compare this.mediaType "===" "image"}}
                                    <div class="image-item" data-src="/gallery/{{this.fileName}}">
                                        <img class="post_image">
                                    </div>
                                {{/compare}}
                                {{#compare this.mediaType "===" "video"}}
                                    <div class="video-item" data-src="/gallery/{{this.fileName}}">
                                        <video class="post_video" controls autoplay loop muted>
                                            <source src="" type="video/mp4">
                                        </video>
                                    </div>
                                {{/compare}}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="post_tail">
                    <div class="caption-post">
                        <p id="caption_text_{{this.MediaId}}" class="caption-text">
                            {{this.messageContent}}
                        </p>
                        <p id="read_more_less_{{this.MediaId}}" class="read-more" onclick="toggleReadMore('{{this.MediaId}}')">Read more</p>
                    </div>
                    <div class="button-container">
                        <btn onclick="edit_post('{{this.MediaId}}','{{this.messageContent}}')" class="edit_button btn "><i class="fa-solid fa-pen-to-square"></i></btn>
                        <a href="javascript:void(0)" onclick="deletePost('{{this.MediaId}}','{{this.mediaType}}')"  class="delete_button btn "><i class="fas fa-trash"></i></a>
                    </div>
                </div>
            </div>
        </div>
    {{/each}}
</section>

<section id="edit_post" class="popup_form_edit">
    <span class="close" onclick="closePopupForm()">&times;</span>
    <div style="width:100%" class="rows">
        <div id="uploadForm_edit" class="right_color_box" style="width:100%;">
            <div class="form_edit_post" id="postForm_edit" action="/edit-post" enctype="multipart/form-data">
                <textarea class="textarea_edit_post" id="description" style="margin-bottom: 50px; min-height: 90px;" name="description" rows="6" oninput="resizeTextarea(); limitCharacters(this, 50);" placeholder="Write a caption..." required></textarea>
                <button onclick="submit_edit_post()" class="button_edit_post darkcolorchanger2">Submit Change</button>
            </div>
        </div>
    </div>
</section>

<div id="loading-indicator">
    <div class="spinner"></div>
    <p>Sending...</p>
</div>

<div id="post-groupchat-container" class="popup-form" style="display: none;">
    <div style="width:100%" class="rows">
        <div id="uploadForm" class="right_color_box" style="width:100%;">
            <p class="close_pop_up" onclick="closePopup()">&#10006;</p>
            <form class="formpostgroup" id="postForm" enctype="multipart/form-data">
                <div id="imageCarousel" class="carousel slide" data-ride="carousel">
                    <div class="carousel-inner" id="previewContainer"></div>
                    <a class="carousel-control-prev" href="#imageCarousel" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#imageCarousel" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>

                <div class="custom-file-upload" style="margin-top: 40px;">
                    <div>
                        <img src="" alt="" style="width:100px;" id="userView">
                        <input class="inputpostgroup" type="file" id="postImage" required name="postImage" accept="image/*,video/*" 
                        multiple onchange="viewpImage(event)">
                    </div>
                </div>

                <textarea class="custom_text_area_postgroup textareapostgroup" id="message-input-group-post" name="messageContent" 
                rows="3" style="min-height: 90px;" placeholder="type your content....." oninput="resizeTextarea(); limitCharacters(this, 50);"></textarea>


                <button class="buttonpostgroup darkcolorchanger2" type="submit" onclick="sendMessageGroupPost(event)">Send</button>
            </form> 
        </div>
    </div>
</div>


<script>

    function showAddImageGalleryMaintainer() {
        var postGroupChatContainer = document.getElementById('post-groupchat-container');
        postGroupChatContainer.style.display = (postGroupChatContainer.style.display === 'none') ? 'block' : 'none';
        (document.body).style.overflow = 'hidden';
    }


    function closePopup() {
        document.getElementById("post-groupchat-container").style.display = "none";
        (document.body).style.overflow = 'auto';
    }


    function viewpImage(event) {
        var input = event.target;

        // Clear previous previews
        document.getElementById('previewContainer').innerHTML = "";
        document.getElementById('userView').src = "";

        if (input.files.length > 1) {
            alert("Please select only one file.");
            input.value = "";
            return;
        }

        var file = input.files[0];
        var fileType = file.type;
        var fileSizeMB = file.size / (1024 * 1024); // Convert size to MB

        if (fileType.includes("image") && fileSizeMB > 5) {
            alert("The selected image exceeds the maximum size of 5 MB.");
            input.value = "";
            return;
        }

        if (fileType.includes("video") && fileSizeMB > 100) {
            alert("The selected video exceeds the maximum size of 100 MB.");
            input.value = "";
            return;
        }

        var carouselInner = document.createElement("div");
        carouselInner.className = "carousel-inner";

        var carouselItem = document.createElement("div");
        carouselItem.className = "carousel-item active";

        // Set a fixed height for carousel items
        carouselItem.style.height = "300px"; // Adjust the height as needed

        if (fileType.includes("video")) {
            var videoPreview = document.createElement("video");
            videoPreview.controls = true;
            videoPreview.classList.add("video-preview_popup");
            var source = document.createElement("source");
            source.src = URL.createObjectURL(file);
            source.type = file.type;

            videoPreview.appendChild(source);
            carouselItem.appendChild(videoPreview);
        } else {
            var imgPreview = document.createElement("img");
            imgPreview.classList.add("image-preview_popup");
            imgPreview.src = URL.createObjectURL(file);
            carouselItem.appendChild(imgPreview);
        }

        carouselInner.appendChild(carouselItem);
        document.getElementById('previewContainer').appendChild(carouselInner);
    }


    function generatemessageId() {
        const timestamp = Math.floor(new Date().getTime() / 1000).toString(16); // Using seconds and converting to hex
        const randomPart = Math.floor(Math.random() * 1679616).toString(16); // Adjusted to generate a 3-character hex
        const uniqueId = timestamp + '0'.repeat(9 - randomPart.length) + randomPart;

        if (uniqueId.length < 24) {
            const remainingChars = 24 - uniqueId.length;
            const additionalRandom = Math.floor(Math.random() * Math.pow(16, remainingChars)).toString(16);
            return uniqueId + '0'.repeat(remainingChars - additionalRandom.length) + additionalRandom;
        }

        return uniqueId;
    } 


    async function sendMessageGroupPost(event) {
        event.preventDefault();

        const popup_form = document.getElementById('post-groupchat-container');
        popup_form.style.display = "none";
        
        const form = document.getElementById('postForm');
        const formData = new FormData(form);
        
        const postImageInput = document.getElementById('postImage');
        if (postImageInput.files.length === 0) {
            alert('Please select an image or video.');
            return;
        }

        // Show the loading indicator
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.style.display = 'block';
        (document.body).style.overflow = 'hidden';
                
        const newMediaId = generatemessageId();
        formData.append('MediaId', newMediaId);
        const url = '/maintainer/add_image_to_gallery_compression';
        const method = 'POST';
        
        try {
            const response = await $.ajax({
                url: url,
                method: method,
                data: formData,
                processData: false,
                contentType: false,
            });
            
            if (response.addedMediaPost) {
                alert('Media added successfully.');
            } else {
                console.error('Failed to upload image');
            }
        } catch (error) {
            console.error('Error uploading post:', error);
        } finally {
            // Hide the loading indicator
            loadingIndicator.style.display = 'none';
            (document.body).style.overflow = "auto";

            // Reset the form to its initial state
            form.reset();

            // Clear preview container
            document.getElementById('previewContainer').innerHTML = '';

            // Clear userView image source
            document.getElementById('userView').src = '';
        }
    }


    function resizeTextarea() {
        var textarea = document.getElementById("message-input-group-post"); 
        var description = document.getElementById("description");
        textarea.style.height = "auto";
        textarea.style.height = (textarea.scrollHeight) + "px";
        description.style.height = "auto";
        description.style.height = (description.scrollHeight) + "px";
    }


    //  ADDING OBSERVER TO ALL RENDERED POSTS AT BEGINNING
    document.addEventListener("DOMContentLoaded", function() {
        initializeObserver();
    });


    //  FUNCTION TO ADD OBSERVER TO EVERY IMAGE AND VIDEO TO ONLY CALL THE SOURCE WHEN REACHED
    const initializeObserver = () => {
        //console.log("INITIALIZE OBSERVER CALLED")
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const image = entry.target.querySelector('.post_image');
                    if (image) {
                        //console.log("IMAGE SOURCE CALLED");
                        image.src = entry.target.dataset.src;
                        observer.unobserve(entry.target);
                    }
                    const video = entry.target.querySelector('video');
                    if (video) {
                        //console.log("VIDEO SOURCE CALLED");
                        const source = video.querySelector('source');
                        source.src = entry.target.dataset.src;
                        video.load();
                        observer.unobserve(entry.target);
                    }
                }
            });
        });


        const imageItems = document.querySelectorAll('.image-item');
        imageItems.forEach(item => {
            //console.log("IMAGE CALLED");
            observer.observe(item);
        });
    
        const videoItems = document.querySelectorAll('.video-item');
        videoItems.forEach(item => {
            //console.log("VIDEO CALLED");
            observer.observe(item);
        });
    };


    async function edit_post(postID, postDescription) {
        await sessionStorage.setItem("gallery_media_id", postID);
        var edit_post_popup = document.getElementById('edit_post');
        var descriptionInput = document.getElementById('description');
        (document.body).style.overflow = 'hidden';
        edit_post_popup.style.display = 'block';
        descriptionInput.value = postDescription;
    }


    //  FUNCTION TO SEND DELETE POST REQUEST TO SERVER
    function deletePost(postId,mediaType) {
        if (confirm("Do you want to delete this media from the gallery?")) {
            $.ajax({
                url: '/maintainer/delete_gallery_media',
                method: 'post',
                data: {
                    PostID: postId,
                    MediaTYPE: mediaType
                },
                success: function (response) {
                    if (response) {
                        var post_container = document.getElementById('post_container_'+postId)
                        if(post_container){
                            post_container.remove();
                        }
                    }
                },
            });
        }
    }


    //  FUNCTION TO READ MORE ON LARGE CAPTIONS
    async function toggleReadMore(PostID) {
        var captionTex_t = document.getElementById('caption_text_' + PostID);
        var see_less_more = document.getElementById('read_more_less_' + PostID);

        if (captionTex_t.style.whiteSpace == 'nowrap' || captionTex_t.style.whiteSpace === '') {
            captionTex_t.style.whiteSpace = 'normal';
            see_less_more.innerText = 'Read less';
        } else {
            captionTex_t.style.whiteSpace = 'nowrap';
            see_less_more.innerText = 'Read more';
        }
    }


    //  FUNCTION TO DISPLAY EDIT POST POPUP
    async function closePopupForm(){
        await sessionStorage.setItem("gallery_media_id", null);
        edit_post_popup = document.getElementById('edit_post');
        var descriptionInput = document.getElementById('description');
        edit_post_popup.style.display = 'none';
        descriptionInput.value = '';
        (document.body).style.overflow = 'auto';
    }


    //    FUNCTION TO SEND EDITED POST TO SERVER
    async function submit_edit_post() {
        var postID = await sessionStorage.getItem("gallery_media_id");
        var edit_post_popup = document.getElementById('edit_post');
        var descriptionInputID = document.getElementById('description');
        descriptionInput = descriptionInputID.value;
        descriptionInput = descriptionInput.replace(/\s+/g, ' ').trim();
        try {
            const response = await $.ajax({
                url: '/maintainer/edit_media_gallery',
                method: 'post',
                data: {
                    PoStId : postID,
                    d_escription : descriptionInput,
                }
            });

            if (response) {
                edit_post_popup.style.display = 'none'
                await sessionStorage.setItem("gallery_media_id", null);
                (document.body).style.overflow = "auto";
                var captionElement = document.getElementById('caption_text_' + postID);
                if (captionElement) {
                    captionElement.textContent = descriptionInput;
                }
            }

        } catch (error) {
            console.error('Error editing post:', error);
        }
    }


    function limitCharacters(textarea, maxChars) {
        if (textarea.value.length > maxChars) {
            alert("You have reached the maximum allowed characters.");
            textarea.value = textarea.value.substring(0, maxChars);
        }
    }

</script>